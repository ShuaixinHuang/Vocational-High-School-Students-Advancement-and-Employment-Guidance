<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>专宝JOBO一对一职业教育升学智能顾问</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- PDF生成库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- 添加中文字体预加载 -->
    <style>
        @font-face {
            font-family: 'SimHei';
            src: url('https://fonts.cdnfonts.com/s/14824/simhei.woff') format('woff');
        }
        
        @font-face {
            font-family: 'Microsoft YaHei';
            src: url('https://fonts.cdnfonts.com/s/8486/ygyxsziti.woff') format('woff');
        }
    </style>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#36D399',
                        accent: '#FF9F1C',
                        dark: '#1E293B',
                        light: '#F8FAFC'
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .scrollbar-hide::-webkit-scrollbar {
                display: none;
            }
            .scrollbar-hide {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
            .typing-dot {
                display: inline-block;
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background-color: #666;
                margin: 0 2px;
                animation: typing 1.4s infinite ease-in-out both;
            }
            .typing-dot:nth-child(1) { animation-delay: 0s; }
            .typing-dot:nth-child(2) { animation-delay: 0.2s; }
            .typing-dot:nth-child(3) { animation-delay: 0.4s; }
            @keyframes typing {
                0% { transform: translateY(0px); }
                28% { transform: translateY(-5px); }
                44% { transform: translateY(0px); }
            }
            
            /* 添加AI回答排版相关的CSS类 */
            .ai-response h3 {
                font-weight: 600;
                font-size: 1.1em;
                margin: 1em 0 0.5em 0;
            }
            
            .ai-response ul, .ai-response ol {
                padding-left: 1.5em;
                margin: 0.5em 0;
            }
            
            .ai-response li {
                margin: 0.3em 0;
            }
            
            .ai-response p {
                margin: 0.5em 0;
            }
            
            .ai-response strong {
                font-weight: 600;
            }
        }
    </style>
</head>
<body class="font-inter bg-gray-50 text-dark min-h-screen flex flex-col">
    <!-- 顶部导航栏 -->
    <header class="bg-white shadow-sm sticky top-0 z-50 transition-all duration-300" id="navbar">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <div class="bg-primary text-white p-2 rounded-lg">
                    <img src="1111.png" alt="图标" class="h-12 w-12"> <!-- 放大图片 -->
                </div>
                <h1 class="text-xl md:text-2xl font-bold text-primary">专宝JOBO一对一职业教育升学智能顾问</h1>
                <img src="2222.png" alt="装饰图片" class="h-16 w-18 ml-2"> <!-- 添加的图片 -->
            </div>
            <div class="flex items-center space-x-4">
                <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-100 transition-colors">
                    <i class="fa fa-moon-o text-gray-600"></i>
                </button>
                <button id="settings-btn" class="p-2 rounded-full hover:bg-gray-100 transition-colors">
                    <i class="fa fa-cog text-gray-600"></i>
                </button>
                <button id="model-status" class="p-2 rounded-full bg-green-100 text-green-600 transition-colors">
                    <i class="fa fa-link"></i>
                </button>
                <button id="generate-report" class="p-2 rounded-full bg-primary/10 text-primary hover:bg-primary/20 transition-colors">
                    <i class="fa fa-file-pdf-o"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- 隐私协议和初始问候弹窗 -->
    <div id="welcome-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-lg w-full max-w-lg p-6 transform transition-all">
            <div class="text-center mb-4">
                <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-primary/10 text-primary mb-4">
                    <i class="fa fa-user-circle text-3xl"></i>
                </div>
                <h3 class="text-xl font-bold mb-2">您好！我是您的专宝JOBO专属生涯规划顾问</h3>
                <p class="text-gray-600">很高兴认识您！为了能为您提供更精准的建议，我需要先了解一些基本信息。</p>
            </div>
            
            <div class="bg-gray-50 p-4 rounded-lg mb-6 text-sm">
                <p class="mb-2"><strong>隐私协议</strong></p>
                <p class="mb-2">我们承诺保护您的隐私，收集的信息仅用于为您提供更好的服务，不会用于其他用途。您可以随时撤回授权。</p>
                <button id="view-privacy" class="text-primary hover:underline flex items-center">
                    <i class="fa fa-file-text-o mr-1"></i> 点击查看隐私文件
                </button>
            </div>
            
            <button id="accept-privacy" class="w-full bg-primary text-white py-3 rounded-lg hover:bg-primary/90 transition-colors font-medium">
                我已了解并同意
            </button>
        </div>
    </div>

    <!-- 隐私协议详情模态框 -->
    <div id="privacy-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-lg w-full max-w-2xl p-6 transform transition-all max-h-[90vh] overflow-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">隐私保护协议</h3>
                <button id="close-privacy" class="text-gray-500 hover:text-gray-700">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            
            <div class="space-y-4 text-sm">
                <div>
                    <h4 class="font-semibold text-lg mb-2">1. 信息收集与使用</h4>
                    <p>我们仅收集您自愿提供的个人信息，包括但不限于姓名、教育背景、职业规划需求等。这些信息仅用于为您提供个性化的职业教育升学咨询服务，帮助我们更好地理解您的需求并提供精准建议。</p>
                </div>
                
                <div>
                    <h4 class="font-semibold text-lg mb-2">2. 信息保护</h4>
                    <p>我们采用严格的技术和管理措施保护您的个人信息安全，防止信息被未经授权的访问、使用或泄露。我们的员工必须遵守严格的隐私政策，仅在必要范围内访问您的信息。</p>
                </div>
                
                <div>
                    <h4 class="font-semibold text-lg mb-2">3. 信息共享</h4>
                    <p>我们不会将您的个人信息出售、出租或与第三方共享，除非获得您的明确许可，或法律要求我们这样做。在提供服务过程中，可能会与必要的服务提供商共享信息，但这些提供商必须遵守我们的隐私保护标准。</p>
                </div>
                
                <div>
                    <h4 class="font-semibold text-lg mb-2">4. 您的权利</h4>
                    <p>您有权随时查看、更正或要求删除您的个人信息。您也可以随时撤回对信息收集和使用的授权，只需联系我们的客服团队即可。</p>
                </div>
                
                <div>
                    <h4 class="font-semibold text-lg mb-2">5. 协议更新</h4>
                    <p>本隐私协议可能会不时更新，任何更新都会在网站上发布。我们建议您定期查看本协议，了解我们如何保护您的信息。</p>
                </div>
            </div>
            
            <div class="mt-6">
                <button id="accept-privacy-from-details" class="w-full bg-primary text-white py-2 rounded-lg hover:bg-primary/90 transition-colors">
                    我已阅读并同意
                </button>
            </div>
        </div>
    </div>

    <!-- 主要内容区域 -->
    <head>
        <!-- 在现有内容后添加以下内容 -->
        <style>
            @font-face {
                font-family: 'SimHei';
                src: url('https://fonts.cdnfonts.com/s/14824/simhei.woff') format('woff');
            }
            
            @font-face {
                font-family: 'Microsoft YaHei';
                src: url('https://fonts.cdnfonts.com/s/8486/ygyxsziti.woff') format('woff');
            }
        </style>
    </head>
    <!-- 主要内容区域 -->
    <main class="flex-grow container mx-auto px-4 py-6 flex flex-col md:flex-row gap-6">
        <!-- 左侧导航面板 -->
        <aside class="hidden md:block w-64 space-y-6">
            <div class="bg-white rounded-xl shadow-sm p-5">
                <h2 class="text-lg font-semibold mb-4 flex items-center">
                    <i class="fa fa-list-ul text-primary mr-2"></i>
                    咨询类别
                </h2>
                <ul class="space-y-2">
                    <li><a href="study-path.html" class="flex items-center p-2 rounded-lg hover:bg-gray-50 transition-colors">
                        <i class="fa fa-graduation-cap text-primary mr-2"></i>
                        升学途径
                    </a></li>
                    <li><a href="college-selection.html" class="flex items-center p-2 rounded-lg hover:bg-gray-50 transition-colors">
                        <i class="fa fa-building text-primary mr-2"></i>
                        院校选择
                    </a></li>
                    <li><a href="major-introduction.html" class="flex items-center p-2 rounded-lg hover:bg-gray-50 transition-colors">
                        <i class="fa fa-book text-primary mr-2"></i>
                        专业介绍
                    </a></li>
                    <li><a href="certificate-exam.html" class="flex items-center p-2 rounded-lg hover:bg-gray-50 transition-colors">
                        <i class="fa fa-certificate text-primary mr-2"></i>
                        证书考试
                    </a></li>
                    <li><a href="employment-prospects.html" class="flex items-center p-2 rounded-lg hover:bg-gray-50 transition-colors">
                        <i class="fa fa-briefcase text-primary mr-2"></i>
                        就业前景
                    </a></li>
                    <li><a href="enrollment-data.html" class="flex items-center p-2 rounded-lg hover:bg-gray-50 transition-colors">
                        <i class="fa fa-bar-chart text-primary mr-2"></i>
                        升学数据
                    </a></li>
                </ul>
            </div>

            <div class="bg-white rounded-xl shadow-sm p-5">
                <h2 class="text-lg font-semibold mb-4 flex items-center">
                    <i class="fa fa-info-circle text-primary mr-2"></i>
                    <a href="enrollment-data.html" class="hover:text-primary transition-colors">升学数据</a>
                </h2>
                <div class="space-y-4">
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span>职业教育升学率</span>
                            <span class="font-semibold">68.5%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-primary h-2 rounded-full" style="width: 68.5%"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span>热门专业就业率</span>
                            <span class="font-semibold">89.2%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-secondary h-2 rounded-full" style="width: 89.2%"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span>技能证书认可度</span>
                            <span class="font-semibold">92.3%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-accent h-2 rounded-full" style="width: 92.3%"></div>
                        </div>
                    </div>
                </div>
                <div class="mt-4 text-center">
                    <a href="enrollment-data.html" class="text-primary hover:text-primary/80 text-sm font-medium flex items-center justify-center">
                        查看详细数据 <i class="fa fa-arrow-right ml-1 text-xs"></i>
                    </a>
                </div>
            </div>

           
            </div>
        </aside>

        <!-- 中间聊天区域 -->
        <section class="flex-grow flex flex-col">
            <div class="bg-white rounded-xl shadow-sm p-6 flex-grow flex flex-col">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold mb-2">专宝JOBO智能咨询助手</h2>
                    <p class="text-gray-600">我是您的专宝JOBO智能咨询助手，专注于职业教育升学咨询。请问有什么可以帮助您？</p>
                </div>
                
                <!-- 聊天历史区域 -->
                <div id="chat-history" class="flex-grow overflow-y-auto scrollbar-hide space-y-4 p-2 mb-6">
                    <!-- 欢迎消息将在用户同意隐私协议后显示 -->
                </div>
                
                <!-- 输入区域 -->
                <div class="relative">
                    <form id="chat-form" class="flex items-center space-x-3">
                        <input type="text" id="user-input" placeholder="请输入您的问题..." 
                            class="flex-grow px-4 py-3 rounded-xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-primary/50 transition-all" disabled>
                        <button type="submit" class="bg-gray-300 text-gray-500 p-3 rounded-xl cursor-not-allowed" disabled>
                            <i class="fa fa-paper-plane"></i>
                        </button>
                    </form>
                    <div id="voice-input" class="absolute right-20 top-1/2 -translate-y-1/2 cursor-pointer p-2 rounded-full hover:bg-gray-100 transition-colors" disabled>
                        <i class="fa fa-microphone text-gray-400"></i>
                    </div>
                </div>
            </div>
        </section>

        <!-- 右侧信息面板 -->
        <aside class="hidden lg:block w-80 space-y-6">
            <div class="bg-white rounded-xl shadow-sm p-5">
                <h2 class="text-lg font-semibold mb-4 flex items-center">
                    <i class="fa fa-lightbulb-o text-primary mr-2"></i>
                    热门问题
                </h2>
                <ul class="space-y-3">
                    <li class="text-sm">
                        <a href="answer1.html" class="block p-3 rounded-lg bg-gray-50 hover:bg-gray-100 transition-colors">
                            职业高中毕业生如何升入本科院校？
                        </a></li>
                    <li class="text-sm">
                        <a href="answer2.html" class="block p-3 rounded-lg bg-gray-50 hover:bg-gray-100 transition-colors">
                            哪些职业技能证书可以获得升学加分？
                        </a></li>
                    <li class="text-sm">
                        <a href="answer3.html" class="block p-3 rounded-lg bg-gray-50 hover:bg-gray-100 transition-colors">
                            专升本考试需要准备哪些科目？
                        </a></li>
                </ul>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm p-5">
                <a href="timeline.html" class="block">
                    <h2 class="text-lg font-semibold mb-4 flex items-center">
                        <i class="fa fa-calendar text-primary mr-2"></i>
                        重要时间节点
                    </h2>
                    <ul class="space-y-3 text-sm">
                        <li class="flex items-start">
                            <div class="bg-primary/10 text-primary text-xs font-semibold px-2 py-1 rounded mr-2 mt-0.5">6月</div>
                            <div>
                                <p class="font-medium">职业技能考试</p>
                                <p class="text-gray-500">6月15日-20日</p>
                            </div>
                        </li>
                        <li class="flex items-start">
                            <div class="bg-primary/10 text-primary text-xs font-semibold px-2 py-1 rounded mr-2 mt-0.5">7月</div>
                            <div>
                                <p class="font-medium">专升本报名</p>
                                <p class="text-gray-500">7月1日-15日</p>
                            </div>
                        </li>
                        <li class="flex items-start">
                            <div class="bg-primary/10 text-primary text-xs font-semibold px-2 py-1 rounded mr-2 mt-0.5">8月</div>
                            <div>
                                <p class="font-medium">升学考试</p>
                                <p class="text-gray-500">8月20日-25日</p>
                            </div>
                        </li>
                        <li class="flex items-start">
                            <div class="bg-primary/10 text-primary text-xs font-semibold px-2 py-1 rounded mr-2 mt-0.5">9月</div>
                            <div>
                                <p class="font-medium">录取结果公布</p>
                                <p class="text-gray-500">9月10日起</p>
                            </div>
                        </li>
                    </ul>
                </a>
            </div>
        </aside>
    </main>

    <!-- 报告生成模态框 -->
    <div id="report-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-lg w-full max-w-md p-6 transform transition-all">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">生成咨询报告</h3>
                <button id="close-report-modal" class="text-gray-500 hover:text-gray-700">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">学生姓名</label>
                    <input type="text" id="student-name" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="请输入学生姓名">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">报告标题</label>
                    <input type="text" id="report-title" class="w-full p-2 border border-gray-300 rounded-lg" value="职业教育升学咨询报告">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">咨询类别</label>
                    <select id="consultation-type" class="w-full p-2 border border-gray-300 rounded-lg">
                        <option value="综合咨询">综合咨询</option>
                        <option value="升学途径">升学途径</option>
                        <option value="院校选择">院校选择</option>
                        <option value="专业介绍">专业介绍</option>
                        <option value="证书考试">证书考试</option>
                        <option value="就业前景">就业前景</option>
                    </select>
                </div>
                <div class="pt-2">
                    <button id="generate-pdf" class="w-full bg-primary text-white py-2 rounded-lg hover:bg-primary/90 transition-colors">
                        生成PDF报告
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 用于PDF生成的隐藏模板 -->
    <div id="pdf-template" class="hidden">
        <div style="width: 210mm; min-height: 297mm; padding: 20mm; font-family: 'Microsoft YaHei', 'SimHei', '微软雅黑', '黑体', sans-serif; font-size: 14px; line-height: 1.5; background-color: #ffffff;">
            <div class="text-center mb-10">
                <h1 style="font-size: 24px; margin-bottom: 10px; font-weight: bold;">职业教育升学咨询报告</h1>
                <p style="font-size: 16px;">专宝JOBO职业教育升学智能顾问</p>
            </div>
            
            <div style="margin-bottom: 15px;">
                <p><span style="font-weight: bold;">学生姓名：</span><span id="pdf-student-name">未知</span></p>
                <p><span style="font-weight: bold;">咨询日期：</span><span id="pdf-date">--</span></p>
                <p><span style="font-weight: bold;">咨询类别：</span><span id="pdf-type">综合咨询</span></p>
            </div>
            
            <div style="border-top: 1px solid #000; padding-top: 10px; margin-bottom: 15px;">
                <h2 style="font-size: 18px; margin-bottom: 10px; font-weight: bold;">一、咨询摘要</h2>
                <div id="pdf-summary" style="line-height: 1.5;">
                    本次咨询围绕职业教育升学相关问题展开，主要涉及升学途径、院校选择、专业介绍等方面的内容。咨询顾问根据学生的具体情况，提供了个性化的建议和指导。
                </div>
            </div>
            
            <div style="border-top: 1px solid #000; padding-top: 10px;">
                <h2 style="font-size: 18px; margin-bottom: 10px; font-weight: bold;">二、详细咨询记录</h2>
                <div id="pdf-details" style="line-height: 1.5;">
                    详细对话内容将显示在此处...
                </div>
            </div>
            
            <div style="margin-top: 30px; text-align: right; font-size: 12px; position: absolute; bottom: 20mm; right: 20mm; width: calc(100% - 40mm);">
                <p>报告生成于：<span id="pdf-generated-date">--</span></p>
                <p>专宝JOBO职业教育升学智能顾问 © 2025</p>
            </div>
        </div>
    </div>

    <script>
        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            // 获取DOM元素
            const chatForm = document.getElementById('chat-form');
            const userInput = document.getElementById('user-input');
            const chatHistory = document.getElementById('chat-history');
            const voiceInputBtn = document.getElementById('voice-input');
            const themeToggle = document.getElementById('theme-toggle');
            const navbar = document.getElementById('navbar');
            const modelStatusBtn = document.getElementById('model-status');
            const generateReportBtn = document.getElementById('generate-report');
            const reportModal = document.getElementById('report-modal');
            const closeReportModalBtn = document.getElementById('close-report-modal');
            const generatePdfBtn = document.getElementById('generate-pdf');
            const studentNameInput = document.getElementById('student-name');
            const consultationTypeSelect = document.getElementById('consultation-type');
            const welcomeModal = document.getElementById('welcome-modal');
            const privacyModal = document.getElementById('privacy-modal');
            const viewPrivacyBtn = document.getElementById('view-privacy');
            const closePrivacyBtn = document.getElementById('close-privacy');
            const acceptPrivacyBtn = document.getElementById('accept-privacy');
            const acceptPrivacyFromDetailsBtn = document.getElementById('accept-privacy-from-details');
            
            // 添加主题切换功能
            const themeIcon = themeToggle.querySelector('i');
            
            // 检查本地存储中的主题设置
            const savedTheme = localStorage.getItem('theme');
            
            // 如果本地存储中有主题设置，则应用它
            if (savedTheme === 'dark') {
                document.body.classList.add('dark');
                themeIcon.classList.remove('fa-moon-o');
                themeIcon.classList.add('fa-sun-o');
                if (navbar) navbar.classList.add('bg-gray-800');
            } else {
                // 默认使用浅色主题
                document.body.classList.remove('dark');
                themeIcon.classList.remove('fa-sun-o');
                themeIcon.classList.add('fa-moon-o');
                if (navbar) navbar.classList.remove('bg-gray-800');
            }
            
            // 主题切换按钮点击事件
            themeToggle.addEventListener('click', function() {
                document.body.classList.toggle('dark');
                
                // 切换图标
                if (document.body.classList.contains('dark')) {
                    themeIcon.classList.remove('fa-moon-o');
                    themeIcon.classList.add('fa-sun-o');
                    if (navbar) navbar.classList.add('bg-gray-800');
                    localStorage.setItem('theme', 'dark');
                } else {
                    themeIcon.classList.remove('fa-sun-o');
                    themeIcon.classList.add('fa-moon-o');
                    if (navbar) navbar.classList.remove('bg-gray-800');
                    localStorage.setItem('theme', 'light');
                }
            });
            
            // 存储对话历史
            let conversationHistory = [];

    
    // 恢复表单数据
    restoreFormData();
    
    // 添加这行来恢复对话历史
    restoreConversationHistory();
    
    // 在DOMContentLoaded事件监听器中添加以下代码

    
    // 检查是否是首次访问
    const hasVisited = localStorage.getItem('hasVisited');
    const privacyAccepted = localStorage.getItem('privacyAccepted');
    
    if (hasVisited === 'true') {
        // 如果不是首次访问
        if (privacyAccepted === 'true') {
            // 隐私协议已接受，隐藏模态框
            welcomeModal.classList.add('hidden');
            privacyModal.classList.add('hidden');
            
            // 启用聊天输入
            userInput.disabled = false;
            chatForm.querySelector('button').disabled = false;
            chatForm.querySelector('button').classList.remove('bg-gray-300', 'text-gray-500', 'cursor-not-allowed');
            chatForm.querySelector('button').classList.add('bg-primary', 'text-white');
            
            // 确保欢迎消息存在
            addWelcomeMessage();
        } else {
            // 隐私协议未接受，显示欢迎模态框
            welcomeModal.classList.remove('hidden');
            privacyModal.classList.add('hidden');
        }
    } else {
        // 首次访问，显示欢迎模态框
        localStorage.setItem('hasVisited', 'true');
        welcomeModal.classList.remove('hidden');
        privacyModal.classList.add('hidden');
    }
    
    // 初始化页面
    scrollToBottom();
    
    // ... 现有代码 ...


            // 恢复对话历史
            function restoreConversationHistory() {
                const savedHistory = localStorage.getItem('conversationHistory');
                if (savedHistory) {
                    try {
                        conversationHistory = JSON.parse(savedHistory);
                        // 重新渲染聊天历史
                        conversationHistory.forEach(msg => {
                            addMessageToChat(msg.content, msg.role === 'user');
                        });
                    } catch (e) {
                        console.error('解析对话历史时出错:', e);
                        conversationHistory = [];
                    }
                }
                

            }

            // 信息收集表单相关元素
            const infoCollectionModal = document.getElementById('info-collection-modal');
            const studentInfoForm = document.getElementById('student-info-form');
            const cancelInfoBtn = document.getElementById('cancel-info');
            
            // 隐私协议相关事件
            // 在用户同意隐私协议后显示信息收集表单
        function acceptPrivacy() {
            // 保存隐私协议接受状态到localStorage
            localStorage.setItem('privacyAccepted', 'true');
            
            // 隐藏隐私协议模态框
            privacyModal.classList.add('hidden');
            
            // 隐藏初始问候弹窗
            welcomeModal.classList.add('hidden');
            
            // 显示信息收集表单
            showInfoCollectionForm();
            
            // 恢复表单数据
            restoreFormData();
            
            // 启用聊天输入
            userInput.disabled = false;
            chatForm.querySelector('button').disabled = false;
            chatForm.querySelector('button').classList.remove('bg-gray-300', 'text-gray-500', 'cursor-not-allowed');
            
            // 只有在还没有欢迎消息时才添加
            const welcomeMessage = document.querySelector('.welcome-message');
            if (!welcomeMessage) {
                addWelcomeMessage();
            }
        }
                    
            closePrivacyBtn.addEventListener('click', function() {
                privacyModal.classList.add('hidden');
                welcomeModal.classList.remove('hidden');
            });
            
            // 显示信息收集表单
            function showInfoCollectionForm() {
                infoCollectionModal.classList.remove('hidden');
            }
            
            // 隐藏信息收集表单
            function hideInfoCollectionForm() {
                infoCollectionModal.classList.add('hidden');
            }
            
            // 从localStorage恢复表单数据
            function restoreFormData() {
                // 恢复原有数据
                const studentName = localStorage.getItem('studentName');
                const educationLevel = localStorage.getItem('educationLevel');
                const interestMajor = localStorage.getItem('interestMajor');
                const 升学目标 = localStorage.getItem('升学目标');
                
                // 恢复新增的基础身份信息
                const gender = localStorage.getItem('gender');
                const birthDate = localStorage.getItem('birthDate');
                
                // 省市数据
                const cityData = {
                    "北京市": ["北京市"],
                    "上海市": ["上海市"],
                    "天津市": ["天津市"],
                    "重庆市": ["重庆市"],
                    "河北省": ["石家庄市", "唐山市", "秦皇岛市", "邯郸市", "邢台市", "保定市", "张家口市", "承德市", "沧州市", "廊坊市", "衡水市"],
                    "山西省": ["太原市", "大同市", "阳泉市", "长治市", "晋城市", "朔州市", "晋中市", "运城市", "忻州市", "临汾市", "吕梁市"],
                    "内蒙古自治区": ["呼和浩特市", "包头市", "乌海市", "赤峰市", "通辽市", "鄂尔多斯市", "呼伦贝尔市", "巴彦淖尔市", "乌兰察布市", "兴安盟", "锡林郭勒盟", "阿拉善盟"],
                    "辽宁省": ["沈阳市", "大连市", "鞍山市", "抚顺市", "本溪市", "丹东市", "锦州市", "营口市", "阜新市", "辽阳市", "盘锦市", "铁岭市", "朝阳市", "葫芦岛市"],
                    "吉林省": ["长春市", "吉林市", "四平市", "辽源市", "通化市", "白山市", "松原市", "白城市", "延边朝鲜族自治州"],
                    "黑龙江省": ["哈尔滨市", "齐齐哈尔市", "鸡西市", "鹤岗市", "双鸭山市", "大庆市", "伊春市", "佳木斯市", "七台河市", "牡丹江市", "黑河市", "绥化市", "大兴安岭地区"],
                    "江苏省": ["南京市", "无锡市", "徐州市", "常州市", "苏州市", "南通市", "连云港市", "淮安市", "盐城市", "扬州市", "镇江市", "泰州市", "宿迁市"],
                    "浙江省": ["杭州市", "宁波市", "温州市", "嘉兴市", "湖州市", "绍兴市", "金华市", "衢州市", "舟山市", "台州市", "丽水市"],
                    "安徽省": ["合肥市", "芜湖市", "蚌埠市", "淮南市", "马鞍山市", "淮北市", "铜陵市", "安庆市", "黄山市", "滁州市", "阜阳市", "宿州市", "六安市", "亳州市", "池州市", "宣城市"],
                    "福建省": ["福州市", "厦门市", "莆田市", "三明市", "泉州市", "漳州市", "南平市", "龙岩市", "宁德市"],
                    "江西省": ["南昌市", "景德镇市", "萍乡市", "九江市", "新余市", "鹰潭市", "赣州市", "吉安市", "宜春市", "抚州市", "上饶市"],
                    "山东省": ["济南市", "青岛市", "淄博市", "枣庄市", "东营市", "烟台市", "潍坊市", "济宁市", "泰安市", "威海市", "日照市", "临沂市", "德州市", "聊城市", "滨州市", "菏泽市"],
                    "河南省": ["郑州市", "开封市", "洛阳市", "平顶山市", "安阳市", "鹤壁市", "新乡市", "焦作市", "濮阳市", "许昌市", "漯河市", "三门峡市", "南阳市", "商丘市", "信阳市", "周口市", "驻马店市"],
                    "湖北省": ["武汉市", "黄石市", "十堰市", "宜昌市", "襄阳市", "鄂州市", "荆门市", "孝感市", "荆州市", "黄冈市", "咸宁市", "随州市", "恩施土家族苗族自治州"],
                    "湖南省": ["长沙市", "株洲市", "湘潭市", "衡阳市", "邵阳市", "岳阳市", "常德市", "张家界市", "益阳市", "郴州市", "永州市", "怀化市", "娄底市", "湘西土家族苗族自治州"],
                    "广东省": ["广州市", "韶关市", "深圳市", "珠海市", "汕头市", "佛山市", "江门市", "湛江市", "茂名市", "肇庆市", "惠州市", "梅州市", "汕尾市", "河源市", "阳江市", "清远市", "东莞市", "中山市", "潮州市", "揭阳市", "云浮市"],
                    "广西壮族自治区": ["南宁市", "柳州市", "桂林市", "梧州市", "北海市", "防城港市", "钦州市", "贵港市", "玉林市", "百色市", "贺州市", "河池市", "来宾市", "崇左市"],
                    "海南省": ["海口市", "三亚市", "三沙市", "儋州市"],
                    "四川省": ["成都市", "自贡市", "攀枝花市", "泸州市", "德阳市", "绵阳市", "广元市", "遂宁市", "内江市", "乐山市", "南充市", "眉山市", "宜宾市", "广安市", "达州市", "雅安市", "巴中市", "资阳市", "阿坝藏族羌族自治州", "甘孜藏族自治州", "凉山彝族自治州"],
                    "贵州省": ["贵阳市", "六盘水市", "遵义市", "安顺市", "毕节市", "铜仁市", "黔西南布依族苗族自治州", "黔东南苗族侗族自治州", "黔南布依族苗族自治州"],
                    "云南省": ["昆明市", "曲靖市", "玉溪市", "保山市", "昭通市", "丽江市", "普洱市", "临沧市", "楚雄彝族自治州", "红河哈尼族彝族自治州", "文山壮族苗族自治州", "西双版纳傣族自治州", "大理白族自治州", "德宏傣族景颇族自治州", "怒江傈僳族自治州", "迪庆藏族自治州"],
                    "西藏自治区": ["拉萨市", "日喀则市", "昌都市", "林芝市", "山南市", "那曲市", "阿里地区"],
                    "陕西省": ["西安市", "铜川市", "宝鸡市", "咸阳市", "渭南市", "延安市", "汉中市", "榆林市", "安康市", "商洛市"],
                    "甘肃省": ["兰州市", "嘉峪关市", "金昌市", "白银市", "天水市", "武威市", "张掖市", "平凉市", "酒泉市", "庆阳市", "定西市", "陇南市", "临夏回族自治州", "甘南藏族自治州"],
                    "青海省": ["西宁市", "海东市", "海北藏族自治州", "黄南藏族自治州", "海南藏族自治州", "果洛藏族自治州", "玉树藏族自治州", "海西蒙古族藏族自治州"],
                    "宁夏回族自治区": ["银川市", "石嘴山市", "吴忠市", "固原市", "中卫市"],
                    "新疆维吾尔自治区": ["乌鲁木齐市", "克拉玛依市", "吐鲁番市", "哈密市", "昌吉回族自治州", "博尔塔拉蒙古自治州", "巴音郭楞蒙古自治州", "阿克苏地区", "克孜勒苏柯尔克孜自治州", "喀什地区", "和田地区", "伊犁哈萨克自治州", "塔城地区", "阿勒泰地区"]
                };

                // 省份选择事件
                document.getElementById('household-province').addEventListener('change', function() {
                    const province = this.value;
                    const citySelect = document.getElementById('household-city');
                    
                    if (province === '') {
                        citySelect.innerHTML = '<option value="">请先选择省份</option>';
                        citySelect.disabled = true;
                    } else {
                        const cities = cityData[province] || [];
                        let options = '<option value="">请选择城市</option>';
                        cities.forEach(city => {
                            options += `<option value="${city}">${city}</option>`;
                        });
                        citySelect.innerHTML = options;
                        citySelect.disabled = false;
                    }
                });
                    const province = localStorage.getItem('householdProvince') || '';
                    const city = localStorage.getItem('householdCity') || '';
                    
                    
                const contactInfo = localStorage.getItem('contactInfo');
                
                // 恢复新增的中考成绩与排名信息
                const chineseScore = localStorage.getItem('chineseScore');
                const mathScore = localStorage.getItem('mathScore');
                const englishScore = localStorage.getItem('englishScore');
                const totalScore = localStorage.getItem('totalScore');
                const ranking = localStorage.getItem('ranking');
                
                // 恢复新增的学业能力证明信息
                const academicTranscript = localStorage.getItem('academicTranscript');
                const skillGrades = localStorage.getItem('skillGrades');
                const certificates = localStorage.getItem('certificates');
                
                // 恢复新增的家庭基础条件信息
                const familyIncome = localStorage.getItem('familyIncome');
                const lowIncome = localStorage.getItem('lowIncome');
                const tuitionCapacity = localStorage.getItem('tuitionCapacity');
                
                // 如果有存储的数据，则填充表单
                if (studentName) document.getElementById('student-name').value = studentName;
                if (educationLevel) document.getElementById('education-level').value = educationLevel;
                if (interestMajor) document.getElementById('interest-major').value = interestMajor;
                if (升学目标) document.getElementById('升学目标').value = 升学目标;
                
                if (gender) document.getElementById('gender').value = gender;
                if (birthDate) document.getElementById('birth-date').value = birthDate;
                if (province) {
                        document.getElementById('household-province').value = province;
                        // 触发省份选择事件以加载城市选项
                        document.getElementById('household-province').dispatchEvent(new Event('change'));
                        // 设置城市值
                        document.getElementById('household-city').value = city;
                    }
                if (contactInfo) document.getElementById('contact-info').value = contactInfo;
                
    
                if (chineseScore) document.getElementById('chinese-score').value = chineseScore;
                if (mathScore) document.getElementById('math-score').value = mathScore;
                if (englishScore) document.getElementById('english-score').value = englishScore;
                if (totalScore) document.getElementById('total-score').value = totalScore;
                if (ranking) document.getElementById('ranking').value = ranking;
                
                if (academicTranscript) document.getElementById('academic-transcript').value = academicTranscript;
                if (skillGrades) document.getElementById('skill-grades').value = skillGrades;
                if (certificates) document.getElementById('certificates').value = certificates;
                
                if (familyIncome) document.getElementById('family-income').value = familyIncome;
                if (lowIncome) document.getElementById('low-income').value = lowIncome;
                if (tuitionCapacity) document.getElementById('tuition-capacity').value = tuitionCapacity;
            }
            
            // 在用户同意隐私协议后显示信息收集表单
            function acceptPrivacy() {
                // 检查是否已经接受过隐私协议
                localStorage.setItem('privacyAccepted', 'true');
                
                // 隐藏隐私协议模态框
                privacyModal.classList.add('hidden');
                
                // 隐藏初始问候弹窗
                welcomeModal.classList.add('hidden');
                
                // 显示信息收集表单
                showInfoCollectionForm();
                
                // 恢复表单数据
                restoreFormData();
                
                // 启用聊天输入
                userInput.disabled = false;
                chatForm.querySelector('button').disabled = false;
                chatForm.querySelector('button').classList.remove('bg-gray-300', 'text-gray-500', 'cursor-not-allowed');
                chatForm.querySelector('button').classList.add('bg-primary', 'text-white');
                
                // 只有在还没有欢迎消息时才添加
                const welcomeMessage = document.querySelector('.welcome-message');
                if (!welcomeMessage) {
                    addWelcomeMessage();
                }
            }
            
            // 取消填写信息
            cancelInfoBtn.addEventListener('click', function() {
                if (confirm('您确定要取消填写吗？填写信息有助于我们为您提供更个性化的咨询服务。')) {
                    hideInfoCollectionForm();
                }
            });
            
            // 处理表单提交
            studentInfoForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // 获取原有表单数据
                const studentName = document.getElementById('student-name').value;
                const educationLevel = document.getElementById('education-level').value;
                const interestMajor = document.getElementById('interest-major').value;
                const 升学目标 = document.getElementById('升学目标').value;
                
                // 获取新增的基础身份信息
                const gender = document.getElementById('gender').value;
                const birthDate = document.getElementById('birth-date').value;
                const province = document.getElementById('household-province').value;
                const city = document.getElementById('household-city').value;
                const contactInfo = document.getElementById('contact-info').value;
                
                // 获取新增的中考成绩与排名信息
                // 获取新增的中考成绩与排名信息
                const chineseScore = document.getElementById('chinese-score').value;
                const mathScore = document.getElementById('math-score').value;
                const englishScore = document.getElementById('english-score').value;
                const totalScore = document.getElementById('total-score').value;
                const ranking = document.getElementById('ranking').value;   
                
                // 获取新增的学业能力证明信息
                const academicTranscript = document.getElementById('academic-transcript').value;
                const skillGrades = document.getElementById('skill-grades').value;
                const certificates = document.getElementById('certificates').value;
                
                // 获取新增的家庭基础条件信息
                const familyIncome = document.getElementById('family-income').value;
                const lowIncome = document.getElementById('low-income').value;
                const tuitionCapacity = document.getElementById('tuition-capacity').value;
                
                // 存储原有数据到本地存储
                localStorage.setItem('studentName', studentName);
                localStorage.setItem('educationLevel', educationLevel);
                localStorage.setItem('interestMajor', interestMajor);
                localStorage.setItem('升学目标', 升学目标);
                
                // 存储新增的基础身份信息到本地存储
                localStorage.setItem('gender', gender);
                localStorage.setItem('birthDate', birthDate);
                localStorage.setItem('householdProvince', province);
                localStorage.setItem('householdCity', city);
                localStorage.setItem('contactInfo', contactInfo);
                
            
                // 存储新增的中考成绩与排名信息到本地存储
                localStorage.setItem('chineseScore', chineseScore);
                localStorage.setItem('mathScore', mathScore);
                localStorage.setItem('englishScore', englishScore);
                localStorage.setItem('totalScore', totalScore);
                localStorage.setItem('ranking', ranking);
              
                // 存储新增的学业能力证明信息到本地存储
                localStorage.setItem('academicTranscript', academicTranscript);
                localStorage.setItem('skillGrades', skillGrades);
                localStorage.setItem('certificates', certificates);
                
                // 存储新增的家庭基础条件信息到本地存储
                localStorage.setItem('familyIncome', familyIncome);
                localStorage.setItem('lowIncome', lowIncome);
                localStorage.setItem('tuitionCapacity', tuitionCapacity);
                
                // 隐藏信息收集表单
                hideInfoCollectionForm();
                
                // 确保隐私协议模态框也被隐藏
                privacyModal.classList.add('hidden');
                
                // 显示欢迎消息（如果还没有显示）
                const welcomeMessage = document.querySelector('.welcome-message');
                if (!welcomeMessage) {
                    addWelcomeMessage();
                }
            });
            
            acceptPrivacyBtn.addEventListener('click', acceptPrivacy);
            acceptPrivacyFromDetailsBtn.addEventListener('click', acceptPrivacy);
            
            // 添加表单提交事件处理
            chatForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                // 检查隐私协议是否已接受
                if (welcomeModal.classList.contains('hidden') === false) {
                    // 如果隐私协议模态框未隐藏，则显示它
                    welcomeModal.classList.remove('hidden');
                    return;
                }
                
                const message = userInput.value.trim();
                if (message) {
                    // 添加用户消息到聊天界面
                    addMessageToChat(message, true);
                    
                    // 清空输入框
                    userInput.value = '';
                    
                    // 增加用户提问计数
                    userQuestionCount++;
                    
                    // 获取AI回复
                    const aiResponse = await getAIResponse(message);
                    
                    // 添加AI回复到聊天界面
                    addMessageToChat(aiResponse, false);
                }
            });
            
            // 添加欢迎消息
            function addWelcomeMessage() {
                // 检查是否已经存在欢迎消息
                const welcomeMessage = document.querySelector('.welcome-message');
                if (welcomeMessage) {
                    return; // 如果已经存在，直接返回
                }
                
                const welcomeDiv = document.createElement('div');
                welcomeDiv.className = 'flex items-start space-x-3 welcome-message'; // 添加welcome-message类名
                welcomeDiv.innerHTML = `
                    <div class="bg-primary text-white p-2 rounded-full">
                        <i class="fa fa-robot"></i>
                    </div>
                    <div class="bg-gray-50 rounded-xl p-4 max-w-[80%]">
                        <p class="text-gray-800">感谢您的信任！为了更好地为您提供职业教育升学建议，您可以告诉我：<br>
                        您感兴趣的专业领域<br>
                        我会根据您的情况提供个性化建议。</p>
                    </div>
                `;
                
                chatHistory.appendChild(welcomeDiv);
                scrollToBottom();
                
                // 保存到对话历史
                conversationHistory.push({
                    role: 'assistant',
                    content: '感谢您的信任！为了更好地为您提供职业教育升学建议，您可以告诉我：您感兴趣的领域，来作为您咨询问题的依据。'
                });
            }
            
            // 滚动到聊天底部
            function scrollToBottom() {
                chatHistory.scrollTop = chatHistory.scrollHeight;
            }
            
            // 添加消息到聊天界面
            function addMessageToChat(message, isUser) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'flex items-start space-x-3';
                
                if (isUser) {
                    messageDiv.innerHTML = `
                        <div class="flex-grow"></div>
                        <div class="bg-primary/10 rounded-xl p-4 max-w-[80%]">
                            <p class="text-gray-800">${message}</p>
                        </div>
                        <div class="bg-gray-200 text-gray-700 p-2 rounded-full">
                            <i class="fa fa-user"></i>
                        </div>
                    `;
                } else {
                    // 格式化AI回答以提高条理性
                    const formattedMessage = formatAIResponse(message);
                    messageDiv.innerHTML = `
                        <div class="bg-primary text-white p-2 rounded-full">
                            <i class="fa fa-robot"></i>
                        </div>
                        <div class="bg-gray-50 rounded-xl p-4 max-w-[80%] ai-response">
                            ${formattedMessage}
                        </div>
                    `;
                }
                
                chatHistory.appendChild(messageDiv);
                scrollToBottom();
                
                // 保存到对话历史
                conversationHistory.push({
                    role: isUser ? 'user' : 'assistant',
                    content: message
                });
                // 保存到对话历史

                // 保存到localStorage
                try {
                    localStorage.setItem('conversationHistory', JSON.stringify(conversationHistory));
                } catch (e) {
                    console.error('保存对话历史时出错:', e);
                }
            }
            
            // 添加"正在思考"动画
            function addTypingIndicator() {
                const typingDiv = document.createElement('div');
                typingDiv.className = 'flex items-start space-x-3';
                typingDiv.id = 'typing-indicator';
                typingDiv.innerHTML = `
                    <div class="bg-primary text-white p-2 rounded-full">
                        <i class="fa fa-robot"></i>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-4 max-w-[80%]">
                        <div class="flex space-x-1">
                            <span class="typing-dot"></span>
                            <span class="typing-dot"></span>
                            <span class="typing-dot"></span>
                        </div>
                    </div>
                `;
                
                chatHistory.appendChild(typingDiv);
                scrollToBottom();
            }
            
            // 移除"正在思考"动画
            function removeTypingIndicator() {
                const typingIndicator = document.getElementById('typing-indicator');
                if (typingIndicator) {
                    typingIndicator.remove();
                }
            }
            
            // 添加询问计数器
            let userQuestionCount = 0;
            
// 调用DeepSeek API获取回复
async function getAIResponse(userMessage) {
    try {
        // 显示"正在思考"动画
        addTypingIndicator();
        
        // 根据询问次数设置不同的系统提示
        let systemPrompt = "你是一个专注于职业教育升学咨询的智能助手。";
        
        if (userQuestionCount < 5) {
            systemPrompt += "在前五次交互中，请主动引导用户提供以下升学相关信息，以了解他们的主观认知和深层需求："+
            "1. 兴趣与职业倾向：通过具体场景引导，如'帮表弟补习时是否享受教学过程？'（教育类职业适配度）、'组织家庭聚餐是否喜欢策划流程？'（酒店管理/会展策划潜力）、'是否排斥重复操作类工作？'（避开机械维修等专业）"+
            "2. 学习动机与抗压能力：分析成绩波动原因，如'物理成绩下滑是因兴趣不足还是方法不当？'；了解抗压表现，如'考试失利后如何调整？更倾向独自消化或求助？'（判断是否适合升学压力大的'职教高考班'）"+
            "3. 家庭支持度与隐性压力：探讨父母期望冲突，如'家人希望学会计，但你更喜欢设计，如何权衡？'；了解经济顾虑，如'若选中外合作班但学费较高，家庭是否需要借贷？'"+
            "4. 价值观排序：了解优先级选择，如'更看重未来薪资，还是工作稳定性？'；探讨地域偏好，如'能否接受异地就读？对通勤时长容忍度？'"+
            "5. 规则认知盲区：验证政策理解，如'你知道艺术类志愿7月17日10点就截止吗？'；纠偏误区，如'是否认为特长生免填志愿？'（强调必须系统填报）"+
            "请保持回答简洁，并在结尾提供1-2个具体问题示例来引导用户继续提问。";
        } else {
            systemPrompt += "请以清晰准确完备有条理的方式回答用户的问题，提供相关的政策信息、升学途径、院校选择建议、专业介绍等内容。请确保回答内容准确、实用，并根据用户的具体问题提供个性化建议。"+
            "在对话中，请继续深入探讨以下主题，以全面了解用户的主观认知和深层需求："+
            "1. 兴趣与职业倾向：通过具体场景引导，了解用户的职业适配度"+
            "2. 学习动机与抗压能力：分析用户的学习动机和抗压表现"+
            "3. 家庭支持度与隐性压力：了解用户家庭的支持度和隐性压力"+
            "4. 价值观排序：了解用户的价值观优先级和地域偏好"+
            "5. 规则认知盲区：验证用户对政策的理解，纠偏误区"+
            "请根据对话历史和已收集的信息，提供个性化的建议和指导。";
        }
        
        // 添加学生基本信息到系统提示
        const studentInfo = {
            studentName: localStorage.getItem('studentName'),
            educationLevel: localStorage.getItem('educationLevel'),
            interestMajor: localStorage.getItem('interestMajor'),
            升学目标: localStorage.getItem('升学目标')
        };
        
        if (studentInfo.studentName || studentInfo.educationLevel || studentInfo.interestMajor || studentInfo.升学目标) {
            systemPrompt += `\n以下是学生的基本信息：`;
            if (studentInfo.studentName) systemPrompt += `\n姓名：${studentInfo.studentName}`;
            if (studentInfo.educationLevel) systemPrompt += `\n教育阶段：${studentInfo.educationLevel}`;
            if (studentInfo.interestMajor) systemPrompt += `\n感兴趣的专业领域：${studentInfo.interestMajor}`;
            if (studentInfo.升学目标) systemPrompt += `\n升学目标：${studentInfo.升学目标}`;
        }
        
        // 准备API请求数据
        const messages = [
            {
                role: "system",
                content: systemPrompt
            },
            ...conversationHistory,
            {
                role: "user",
                content: userMessage
            }
        ];
        
        // 构建API请求
        const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer sk-c57b3a1e78294f3b8e5c7c29a9c05bae'
            },
            body: JSON.stringify({
                model: 'deepseek-chat',
                messages: messages,
                temperature: 0.7,
                max_tokens: 1000
            })
        });
        
        if (!response.ok) {
            throw new Error(`API请求失败: ${response.status}`);
        }
        
        const data = await response.json();
        const aiResponse = data.choices[0].message.content;
        
        // 移除"正在思考"动画
        removeTypingIndicator();
        
        return aiResponse;
    } catch (error) {
        console.error('获取AI回复时出错:', error);
        
        // 移除"正在思考"动画
        removeTypingIndicator();
        
        // 返回错误消息
        return "很抱歉，获取回复时发生错误。请稍后再试。";
    }
}
            
            // 格式化AI回答以提高条理性
            function formatAIResponse(response) {
                // 前五次询问：简要概括用户特点，并引导用户提问
                response = response.replace(/[\*#]/g, '');
                if (userQuestionCount < 5) {
                    // 保持AI回复的简洁性，仅进行基本的HTML格式化
                    let simplifiedResponse = response.trim();
                    
                    // 移除可能的问候语
                    if (simplifiedResponse.startsWith("你好") || simplifiedResponse.startsWith("您好")) {
                        simplifiedResponse = simplifiedResponse.substring(simplifiedResponse.indexOf("，") + 1).trim();
                    }
                     
 
                    // 如果回答过长，进行截断
                    if (simplifiedResponse.length > 200) {
                        simplifiedResponse = simplifiedResponse.substring(0, 200) + "...";
                    }
                        // 检测数字并分行显示
                    let formattedResponse = '';
                    
                    // 使用正则表达式匹配数字点开头的内容
                    const pointPattern = /(\d+)\.(.*?)(?=(\d+\.|$))/gs;
                    const matches = [...simplifiedResponse.matchAll(pointPattern)];
                    
                    if (matches.length > 0) {
                        // 如果检测到数字点，按数字点分行
                        formattedResponse = '<div style="margin-bottom: 15px;">';
                        
                        for (const match of matches) {
                            const pointNumber = match[1];
                            const pointContent = match[2].trim();
                            
                            if (pointContent) {
                                formattedResponse += `<p><strong>${pointNumber}.</strong> ${pointContent}</p>`;
                            }
                        }
                        
                        formattedResponse += '</div>';
                    } else {
                        // 如果没有检测到数字点，尝试按换行符分割
                        const lines = simplifiedResponse.split('\n').filter(line => line.trim() !== '');
                        
                        if (lines.length > 1) {
                            // 如果有多行，按行分行
                            formattedResponse = '<div style="margin-bottom: 15px;">';
                            
                            lines.forEach((line, index) => {
                                formattedResponse += `<p>${line.trim()}</p>`;
                            });
                            
                            formattedResponse += '</div>';
                        } else {
                            // 如果只有一行，保持原有格式
                            formattedResponse = `<p>${simplifiedResponse}</p>`;
                        }
                    }
        
                    // 统一格式化，确保每次回复都保持简洁一致
                    return `<p>${simplifiedResponse}</p><p style="margin-top: 10px; font-weight: bold;">请告诉我更多关于您的情况，我将为您提供更详细的建议。</p>`;
                }
                
                // 第六次及以后的询问：以清晰准确完备有条理的方式回答
                // 精简AI回答
                // 移除开头和结尾的空白字符
                let trimmedResponse = response.trim();
                
                // 如果回答以问候语开头，则移除
                if (trimmedResponse.startsWith("你好") || trimmedResponse.startsWith("您好")) {
                    trimmedResponse = trimmedResponse.substring(trimmedResponse.indexOf("，") + 1).trim();
                }
                
                // 检查是否已经是结构化内容（包含明显的标题或列表）
                const hasStructure = trimmedResponse.includes('\n\n1.') || 
                                     trimmedResponse.includes('\n\n一、') || 
                                     trimmedResponse.includes('\n\n二、') || 
                                     trimmedResponse.includes('\n- ') || 
                                     trimmedResponse.includes('\n* ');
                
                if (hasStructure) {
                    // 对已有的结构化内容进行更好的HTML转换
                    return formatStructuredResponse(trimmedResponse);
                } else {
                    // 对非结构化内容进行智能分段和结构化处理
                    return formatUnstructuredResponse(trimmedResponse);
                }
                // 格式化结构化响应
function formatStructuredResponse(response) {
    // 将换行符替换为HTML换行标签
    response = response.replace(/[\*#]/g, '');
    let formattedResponse = response.replace(/\n/g, '<br>');
    
    
    // 将列表项格式化为HTML列表
    formattedResponse = formattedResponse.replace(/\d+\.(.+)/g, '<li>$1</li>');
    formattedResponse = formattedResponse.replace(/(<li>.+<\/li>)+/g, '<ol>$&</ol>');
    
    // 将标题格式化为HTML标题标签
    formattedResponse = formattedResponse.replace(/^(.+)$/gm, '<p>$1</p>');
    
    return formattedResponse;
}

// 格式化非结构化响应
function formatUnstructuredResponse(response) {
    response = response.replace(/[\*#]/g, '');
    // 对非结构化内容进行智能分段
    // 这里我们简单地按句号分割，并为每个句子创建一个段落
    const sentences = response.split(/\。|\！|\？/).filter(sentence => sentence.trim() !== '');
    
    if (sentences.length <= 1) {
        // 如果只有一句话或没有句号，直接返回
        return `<p>${response}</p>`;
    }
    
    // 为每个句子创建一个段落
    const paragraphs = sentences.map(sentence => `<p>${sentence}</p>`);
    return paragraphs.join('\n');
}
            }
            
            
            // 报告生成模态框事件处理
generateReportBtn.addEventListener('click', function() {
    reportModal.classList.remove('hidden');
});

closeReportModalBtn.addEventListener('click', function() {
    reportModal.classList.add('hidden');
});

// 生成报告仪表板
generatePdfBtn.addEventListener('click', function() {
    const studentName = studentNameInput.value || '未知';
    const reportTitle = document.getElementById('report-title').value || '职业教育升学咨询报告';
    const consultationType = consultationTypeSelect.value || '综合咨询';
    
    // 生成咨询摘要
    let summary = '本次咨询围绕职业教育升学相关问题展开，主要涉及';
    const topics = [];
    
    // 分析对话历史生成摘要
    conversationHistory.forEach(msg => {
        if (msg.role === 'user') {
            if ((msg.content.includes('升学') || msg.content.includes('专升本')) && !topics.includes('升学途径')) {
                topics.push('升学途径');
            }
            if (msg.content.includes('专业') && !topics.includes('专业介绍')) {
                topics.push('专业介绍');
            }
            if ((msg.content.includes('院校') || msg.content.includes('学校')) && !topics.includes('院校选择')) {
                topics.push('院校选择');
            }
            if (msg.content.includes('就业') && !topics.includes('就业前景')) {
                topics.push('就业前景');
            }
            if ((msg.content.includes('证书') || msg.content.includes('考试')) && !topics.includes('证书考试')) {
                topics.push('证书考试');
            }
        }
    });
    
    summary += topics.length > 0 ? topics.join('、') + '等方面的内容。' : '多个方面的问题。';
    summary += '咨询顾问根据学生的具体情况，提供了个性化的建议和指导。';
    
    // 生成详细咨询记录
    let detailsHTML = '';
    conversationHistory.forEach((msg, index) => {
        if (msg.role === 'user') {
            detailsHTML += `<div style="margin-bottom: 15px;"><strong>学生：</strong>${msg.content}</div>`;
        } else {
            // 移除AI回复中的HTML标签以获得纯文本
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = formatAIResponse(msg.content);
            const plainText = tempDiv.textContent || tempDiv.innerText || '';
            detailsHTML += `<div style="margin-bottom: 15px;"><strong>顾问：</strong>${plainText}</div>`;
        }
    });
    
    // 将数据存储到localStorage
    const reportData = {
        studentName: studentName,
        reportTitle: reportTitle,
        consultationType: consultationType,
        date: new Date().toLocaleDateString('zh-CN'),
        generatedDate: new Date().toLocaleString('zh-CN'),
        summary: summary,
        details: detailsHTML
    };
    
    localStorage.setItem('reportData', JSON.stringify(reportData));
    
    // 跳转到报告仪表板页面
    window.open('report-dashboard.html', '_blank');
    
    // 关闭模态框
    reportModal.classList.add('hidden');
});
           
            // 恢复表单数据
            restoreFormData();
            
            // 初始化页面
            scrollToBottom();
        });
    </script>
</body>
</html>
    <!-- 信息收集表单模态框 -->
    <div id="info-collection-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-lg w-full max-w-md p-6 transform transition-all max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">完善个人信息</h3>
                <button id="cancel-info" class="text-gray-500 hover:text-gray-700">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            
            <form id="student-info-form" class="space-y-4 overflow-y-auto pr-2 flex-grow">
                <div>
                    <label class="block text-sm font-medium mb-1">姓名 *</label>
                    <input type="text" id="student-name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50" required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-1">教育阶段 *</label>
                    <select id="education-level" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50" required>
                        <option value="">请选择</option>
                        <option value="初中">初中</option>
                        <option value="高中">高中</option>
                        <option value="中职">中职</option>
                        <option value="高职">高职</option>
                        <option value="其他">其他</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-1">感兴趣的专业领域</label>
                    <input type="text" id="interest-major" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50" placeholder="例如：计算机、机械、护理等">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">升学目标</label>
                    <select id="升学目标" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50">
                        <option value="">请选择</option>
                        <option value="升入高职">升入高职</option>
                        <option value="升入本科">升入本科</option>
                        <option value="升入专科">升入专科</option>
                        <option value="其他">其他</option>
                    </select>
                </div>
                
                <!-- 添加结构化信息收集表格 -->
                <div class="mt-4">
                    <h4 class="text-lg font-semibold mb-2">基础身份信息</h4>
                    <table class="w-full text-sm border-collapse border border-gray-300">
                        <tr>
                            <td class="border border-gray-300 p-2 bg-gray-50">性别</td>
                            <td class="border border-gray-300 p-2">
                                <select id="gender" class="w-full px-2 py-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-primary/50">
                                    <option value="">请选择</option>
                                    <option value="男">男</option>
                                    <option value="女">女</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td class="border border-gray-300 p-2 bg-gray-50">出生日期</td>
                            <td class="border border-gray-300 p-2">
                                <input type="date" id="birth-date" class="w-full px-2 py-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-primary/50">
                            </td>
                        </tr>
                        <tr>
                            <td class="border border-gray-300 p-2 bg-gray-50">户籍所在地</td>
                            <td class="border border-gray-300 p-2">
                                <div class="flex space-x-2">
                                    <select id="household-province" class="flex-1 px-2 py-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-primary/50">
                                        <option value="">请选择省份</option>
                                        <option value="北京市">北京市</option>
                                        <option value="上海市">上海市</option>
                                        <option value="天津市">天津市</option>
                                        <option value="重庆市">重庆市</option>
                                        <option value="河北省">河北省</option>
                                        <option value="山西省">山西省</option>
                                        <option value="内蒙古自治区">内蒙古自治区</option>
                                        <option value="辽宁省">辽宁省</option>
                                        <option value="吉林省">吉林省</option>
                                        <option value="黑龙江省">黑龙江省</option>
                                        <option value="江苏省">江苏省</option>
                                        <option value="浙江省">浙江省</option>
                                        <option value="安徽省">安徽省</option>
                                        <option value="福建省">福建省</option>
                                        <option value="江西省">江西省</option>
                                        <option value="山东省">山东省</option>
                                        <option value="河南省">河南省</option>
                                        <option value="湖北省">湖北省</option>
                                        <option value="湖南省">湖南省</option>
                                        <option value="广东省">广东省</option>
                                        <option value="广西壮族自治区">广西壮族自治区</option>
                                        <option value="海南省">海南省</option>
                                        <option value="四川省">四川省</option>
                                        <option value="贵州省">贵州省</option>
                                        <option value="云南省">云南省</option>
                                        <option value="西藏自治区">西藏自治区</option>
                                        <option value="陕西省">陕西省</option>
                                        <option value="甘肃省">甘肃省</option>
                                        <option value="青海省">青海省</option>
                                        <option value="宁夏回族自治区">宁夏回族自治区</option>
                                        <option value="新疆维吾尔自治区">新疆维吾尔自治区</option>
                                    </select>
                                    <select id="household-city" class="flex-1 px-2 py-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-primary/50" disabled>
                                        <option value="">请先选择省份</option>
                                    </select>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td class="border border-gray-300 p-2 bg-gray-50">联系方式</td>
                            <td class="border border-gray-300 p-2">
                                <input type="text" id="contact-info" class="w-full px-2 py-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-primary/50" placeholder="请输入联系方式">
                            </td>
                        </tr>
                    </table>
                    <p class="text-xs text-gray-500 mt-1">（用途：用于完善学生基本信息档案）</p>
                </div>
                
                <div class="mt-4">
                    <h4 class="text-lg font-semibold mb-2">中考成绩与排名</h4>
                    <table class="w-full text-sm border-collapse border border-gray-300">
                        <tr>
                            <td class="border border-gray-300 p-2 bg-gray-50">语文分数</td>
                            <td class="border border-gray-300 p-2">
                                <input type="number" id="chinese-score" class="w-full px-2 py-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-primary/50" placeholder="请输入语文分数">
                            </td>
                        </tr>
                        <tr>
                            <td class="border border-gray-300 p-2 bg-gray-50">数学分数</td>
                            <td class="border border-gray-300 p-2">
                                <input type="number" id="math-score" class="w-full px-2 py-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-primary/50" placeholder="请输入数学分数">
                            </td>
                        </tr>
                        <tr>
                            <td class="border border-gray-300 p-2 bg-gray-50">英语分数</td>
                            <td class="border border-gray-300 p-2">
                                <input type="number" id="english-score" class="w-full px-2 py-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-primary/50" placeholder="请输入英语分数">
                            </td>
                        </tr>
                        <tr>
                            <td class="border border-gray-300 p-2 bg-gray-50">总分</td>
                            <td class="border border-gray-300 p-2">
                                <input type="number" id="total-score" class="w-full px-2 py-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-primary/50" placeholder="请输入总分">
                            </td>
                        </tr>
                        <tr>
                            <td class="border border-gray-300 p-2 bg-gray-50">该地区总分满分</td>
                            <td class="border border-gray-300 p-2">
                                <input type="number" id="total-full-score" class="w-full px-2 py-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-primary/50" placeholder="请输入总分满分">
                            </td>
                        </tr>
                        <tr>
                            <td class="border border-gray-300 p-2 bg-gray-50">全市排名位次</td>
                            <td class="border border-gray-300 p-2">
                                <input type="number" id="ranking" class="w-full px-2 py-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-primary/50" placeholder="请输入排名">
                            </td>
                        </tr>
                    </table>
                    <p class="text-xs text-gray-500 mt-1">（用途：判断志愿梯度与录取概率的核心依据）</p>
                </div>
                
                <div class="mt-4">
                    <h4 class="text-lg font-semibold mb-2">学业能力证明</h4>
                    <table class="w-full text-sm border-collapse border border-gray-300">
                        <tr>
                            <td class="border border-gray-300 p-2 bg-gray-50">文化课成绩单</td>
                            <td class="border border-gray-300 p-2">
                                <textarea id="academic-transcript" class="w-full px-2 py-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-primary/50" placeholder="请输入文化课成绩，如语数外主科+物理/化学等弱项科目"></textarea>
                            </td>
                        </tr>
                        <tr>
                            <td class="border border-gray-300 p-2 bg-gray-50">技能课成绩</td>
                            <td class="border border-gray-300 p-2">
                                <input type="text" id="skill-grades" class="w-full px-2 py-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-primary/50" placeholder="如信息技术、实验操作等级">
                            </td>
                        </tr>
                        <tr>
                            <td class="border border-gray-300 p-2 bg-gray-50">获奖证书</td>
                            <td class="border border-gray-300 p-2">
                                <textarea id="certificates" class="w-full px-2 py-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-primary/50" placeholder="请输入获奖证书信息，如学科竞赛、技能大赛"></textarea>
                            </td>
                        </tr>
                    </table>
                    <p class="text-xs text-gray-500 mt-1">（用途：匹配需专业基础的职高方向，如人工智能、物联网）</p>
                </div>
                
                <div class="mt-4">
                    <h4 class="text-lg font-semibold mb-2">家庭基础条件</h4>
                    <table class="w-full text-sm border-collapse border border-gray-300">
                        <tr>
                            <td class="border border-gray-300 p-2 bg-gray-50">家庭年收入范围</td>
                            <td class="border border-gray-300 p-2">
                                <select id="family-income" class="w-full px-2 py-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-primary/50">
                                    <option value="">请选择</option>
                                    <option value="5万以下">5万以下</option>
                                    <option value="5-10万">5-10万</option>
                                    <option value="10-20万">10-20万</option>
                                    <option value="20万以上">20万以上</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td class="border border-gray-300 p-2 bg-gray-50">是否低保户/建档立卡</td>
                            <td class="border border-gray-300 p-2">
                                <select id="low-income" class="w-full px-2 py-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-primary/50">
                                    <option value="">请选择</option>
                                    <option value="是">是</option>
                                    <option value="否">否</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td class="border border-gray-300 p-2 bg-gray-50">可承受学费上限</td>
                            <td class="border border-gray-300 p-2">
                                <select id="tuition-capacity" class="w-full px-2 py-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-primary/50">
                                    <option value="">请选择</option>
                                    <option value="2万以下">2万以下</option>
                                    <option value="2-3万">2-3万</option>
                                    <option value="3-5万">3-5万</option>
                                    <option value="5万以上">5万以上</option>
                                </select>
                            </td>
                        </tr>
                    </table>
                    <p class="text-xs text-gray-500 mt-1">（用途：筛选公办免学费或助学金项目）</p>
                </div>
                
                <div class="mt-6">
                    <button type="submit" class="w-full bg-primary text-white py-2 rounded-lg hover:bg-primary/90 transition-colors">
                        提交信息
                    </button>
                </div>
            </form>
        </div>
    </div>