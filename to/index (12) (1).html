<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>一对一职业教育升学智能顾问</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- PDF生成库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- 添加中文字体预加载 -->
    <style>
        @font-face {
            font-family: 'SimHei';
            src: url('https://fonts.cdnfonts.com/s/14824/simhei.woff') format('woff');
        }
        
        @font-face {
            font-family: 'Microsoft YaHei';
            src: url('https://fonts.cdnfonts.com/s/8486/ygyxsziti.woff') format('woff');
        }
    </style>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#36D399',
                        accent: '#FF9F1C',
                        dark: '#1E293B',
                        light: '#F8FAFC'
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .scrollbar-hide::-webkit-scrollbar {
                display: none;
            }
            .scrollbar-hide {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
            .typing-dot {
                display: inline-block;
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background-color: #666;
                margin: 0 2px;
                animation: typing 1.4s infinite ease-in-out both;
            }
            .typing-dot:nth-child(1) { animation-delay: 0s; }
            .typing-dot:nth-child(2) { animation-delay: 0.2s; }
            .typing-dot:nth-child(3) { animation-delay: 0.4s; }
            @keyframes typing {
                0% { transform: translateY(0px); }
                28% { transform: translateY(-5px); }
                44% { transform: translateY(0px); }
            }
            
            /* 添加AI回答排版相关的CSS类 */
            .ai-response h3 {
                font-weight: 600;
                font-size: 1.1em;
                margin: 1em 0 0.5em 0;
            }
            
            .ai-response ul, .ai-response ol {
                padding-left: 1.5em;
                margin: 0.5em 0;
            }
            
            .ai-response li {
                margin: 0.3em 0;
            }
            
            .ai-response p {
                margin: 0.5em 0;
            }
            
            .ai-response strong {
                font-weight: 600;
            }
        }
    </style>
</head>
<body class="font-inter bg-gray-50 text-dark min-h-screen flex flex-col">
    <!-- 顶部导航栏 -->
    <header class="bg-white shadow-sm sticky top-0 z-50 transition-all duration-300" id="navbar">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <div class="bg-primary text-white p-2 rounded-lg">
                    <img src="1111.png" alt="图标" class="h-12 w-12"> <!-- 放大图片 -->
                </div>
                <h1 class="text-xl md:text-2xl font-bold text-primary">一对一职业教育升学智能顾问</h1>
                <!-- 删除了右边的图案 -->
            </div>
            <div class="flex items-center space-x-4">
                <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-100 transition-colors">
                    <i class="fa fa-moon-o text-gray-600"></i>
                </button>
                <button id="settings-btn" class="p-2 rounded-full hover:bg-gray-100 transition-colors">
                    <i class="fa fa-cog text-gray-600"></i>
                </button>
                <button id="model-status" class="p-2 rounded-full bg-green-100 text-green-600 transition-colors">
                    <i class="fa fa-link"></i>
                </button>
                <button id="generate-report" class="p-2 rounded-full bg-primary/10 text-primary hover:bg-primary/20 transition-colors">
                    <i class="fa fa-file-pdf-o"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- 隐私协议和初始问候弹窗 -->
    <div id="welcome-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-lg w-full max-w-lg p-6 transform transition-all">
            <div class="text-center mb-4">
                <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-primary/10 text-primary mb-4">
                    <i class="fa fa-user-circle text-3xl"></i>
                </div>
                <h3 class="text-xl font-bold mb-2">您好！我是您的专属生涯规划顾问</h3>
                <p class="text-gray-600">很高兴认识您！为了能为您提供更精准的建议，我需要先了解一些基本信息。</p>
            </div>
            
            <div class="bg-gray-50 p-4 rounded-lg mb-6 text-sm">
                <p class="mb-2"><strong>隐私协议</strong></p>
                <p class="mb-2">我们承诺保护您的隐私，收集的信息仅用于为您提供更好的服务，不会用于其他用途。您可以随时撤回授权。</p>
                <button id="view-privacy" class="text-primary hover:underline flex items-center">
                    <i class="fa fa-file-text-o mr-1"></i> 点击查看隐私文件
                </button>
            </div>
            
            <button id="accept-privacy" class="w-full bg-primary text-white py-3 rounded-lg hover:bg-primary/90 transition-colors font-medium">
                我已了解并同意
            </button>
        </div>
    </div>

    <!-- 隐私协议详情模态框 -->
    <div id="privacy-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-lg w-full max-w-2xl p-6 transform transition-all max-h-[90vh] overflow-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">隐私保护协议</h3>
                <button id="close-privacy" class="text-gray-500 hover:text-gray-700">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            
            <div class="space-y-4 text-sm">
                <div>
                    <h4 class="font-semibold text-lg mb-2">1. 信息收集与使用</h4>
                    <p>我们仅收集您自愿提供的个人信息，包括但不限于姓名、教育背景、职业规划需求等。这些信息仅用于为您提供个性化的职业教育升学咨询服务，帮助我们更好地理解您的需求并提供精准建议。</p>
                </div>
                
                <div>
                    <h4 class="font-semibold text-lg mb-2">2. 信息保护</h4>
                    <p>我们采用严格的技术和管理措施保护您的个人信息安全，防止信息被未经授权的访问、使用或泄露。我们的员工必须遵守严格的隐私政策，仅在必要范围内访问您的信息。</p>
                </div>
                
                <div>
                    <h4 class="font-semibold text-lg mb-2">3. 信息共享</h4>
                    <p>我们不会将您的个人信息出售、出租或与第三方共享，除非获得您的明确许可，或法律要求我们这样做。在提供服务过程中，可能会与必要的服务提供商共享信息，但这些提供商必须遵守我们的隐私保护标准。</p>
                </div>
                
                <div>
                    <h4 class="font-semibold text-lg mb-2">4. 您的权利</h4>
                    <p>您有权随时查看、更正或要求删除您的个人信息。您也可以随时撤回对信息收集和使用的授权，只需联系我们的客服团队即可。</p>
                </div>
                
                <div>
                    <h4 class="font-semibold text-lg mb-2">5. 协议更新</h4>
                    <p>本隐私协议可能会不时更新，任何更新都会在网站上发布。我们建议您定期查看本协议，了解我们如何保护您的信息。</p>
                </div>
            </div>
            
            <div class="mt-6">
                <button id="accept-privacy-from-details" class="w-full bg-primary text-white py-2 rounded-lg hover:bg-primary/90 transition-colors">
                    我已阅读并同意
                </button>
            </div>
        </div>
    </div>

    <!-- 主要内容区域 -->
    <head>
        <!-- 在现有内容后添加以下内容 -->
        <style>
            @font-face {
                font-family: 'SimHei';
                src: url('https://fonts.cdnfonts.com/s/14824/simhei.woff') format('woff');
            }
            
            @font-face {
                font-family: 'Microsoft YaHei';
                src: url('https://fonts.cdnfonts.com/s/8486/ygyxsziti.woff') format('woff');
            }
        </style>
    </head>
    <!-- 主要内容区域 -->
    <main class="flex-grow container mx-auto px-4 py-6 flex flex-col md:flex-row gap-6">
        <!-- 左侧导航面板 -->
        <aside class="hidden md:block w-64 space-y-6">
            <div class="bg-white rounded-xl shadow-sm p-5">
                <h2 class="text-lg font-semibold mb-4 flex items-center">
                    <i class="fa fa-list-ul text-primary mr-2"></i>
                    咨询类别
                </h2>
                <ul class="space-y-2">
                    <li><a href="#" class="flex items-center p-2 rounded-lg hover:bg-gray-50 transition-colors">
                        <i class="fa fa-graduation-cap text-primary mr-2"></i>
                        升学途径
                    </a></li>
                    <li><a href="#" class="flex items-center p-2 rounded-lg hover:bg-gray-50 transition-colors">
                        <i class="fa fa-building text-primary mr-2"></i>
                        院校选择
                    </a></li>
                    <li><a href="#" class="flex items-center p-2 rounded-lg hover:bg-gray-50 transition-colors">
                        <i class="fa fa-book text-primary mr-2"></i>
                        专业介绍
                    </a></li>
                    <li><a href="#" class="flex items-center p-2 rounded-lg hover:bg-gray-50 transition-colors">
                        <i class="fa fa-certificate text-primary mr-2"></i>
                        证书考试
                    </a></li>
                    <li><a href="#" class="flex items-center p-2 rounded-lg hover:bg-gray-50 transition-colors">
                        <i class="fa fa-briefcase text-primary mr-2"></i>
                        就业前景
                    </a></li>
                </ul>
            </div>

            <div class="bg-white rounded-xl shadow-sm p-5">
                <h2 class="text-lg font-semibold mb-4 flex items-center">
                    <i class="fa fa-lightbulb-o text-primary mr-2"></i>
                    热门问题
                </h2>
                <ul class="space-y-3">
                    <li class="text-sm">
                        <a href="answer1.html" class="block p-3 rounded-lg bg-gray-50 hover:bg-gray-100 transition-colors">
                            职业高中毕业生如何升入本科院校？
                        </a></li>
                    <li class="text-sm">
                        <a href="answer2.html" class="block p-3 rounded-lg bg-gray-50 hover:bg-gray-100 transition-colors">
                            哪些职业技能证书可以获得升学加分？
                        </a></li>
                    <li class="text-sm">
                        <a href="answer3.html" class="block p-3 rounded-lg bg-gray-50 hover:bg-gray-100 transition-colors">
                            专升本考试需要准备哪些科目？
                        </a></li>
                </ul>
            </div>
        </aside>

        <!-- 中间聊天区域 -->
        <section class="flex-grow flex flex-col">
            <div class="bg-white rounded-xl shadow-sm p-6 flex-grow flex flex-col">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold mb-2">智能咨询助手</h2>
                    <p class="text-gray-600">我是您的智能咨询助手，专注于职业教育升学咨询。请问有什么可以帮助您？</p>
                </div>
                
                <!-- 聊天历史区域 -->
                <div id="chat-history" class="flex-grow overflow-y-auto scrollbar-hide space-y-4 p-2 mb-6">
                    <!-- 欢迎消息将在用户同意隐私协议后显示 -->
                </div>
                
                <!-- 输入区域 -->
                <div class="relative">
                    <form id="chat-form" class="flex items-center space-x-3">
                        <input type="text" id="user-input" placeholder="请输入您的问题..." 
                            class="flex-grow px-4 py-3 rounded-xl border border-gray-200 focus:outline-none focus:ring-2 focus:ring-primary/50 transition-all" disabled>
                        <button type="submit" class="bg-gray-300 text-gray-500 p-3 rounded-xl cursor-not-allowed" disabled>
                            <i class="fa fa-paper-plane"></i>
                        </button>
                    </form>
                    <div id="voice-input" class="absolute right-20 top-1/2 -translate-y-1/2 cursor-pointer p-2 rounded-full hover:bg-gray-100 transition-colors" disabled>
                        <i class="fa fa-microphone text-gray-400"></i>
                    </div>
                </div>
            </div>
        </section>

        <!-- 右侧信息面板 -->
        <aside class="hidden lg:block w-80 space-y-6">
            <div class="bg-white rounded-xl shadow-sm p-5">
                <h2 class="text-lg font-semibold mb-4 flex items-center">
                    <i class="fa fa-info-circle text-primary mr-2"></i>
                    升学数据
                </h2>
                <div class="space-y-4">
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span>职业教育升学率</span>
                            <span class="font-semibold">68.5%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-primary h-2 rounded-full" style="width: 68.5%"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span>热门专业就业率</span>
                            <span class="font-semibold">89.2%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-secondary h-2 rounded-full" style="width: 89.2%"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span>技能证书认可度</span>
                            <span class="font-semibold">92.3%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="bg-accent h-2 rounded-full" style="width: 92.3%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm p-5">
                <h2 class="text-lg font-semibold mb-4 flex items-center">
                    <i class="fa fa-calendar text-primary mr-2"></i>
                    重要时间节点
                </h2>
                <ul class="space-y-3 text-sm">
                    <li class="flex items-start">
                        <div class="bg-primary/10 text-primary text-xs font-semibold px-2 py-1 rounded mr-2 mt-0.5">6月</div>
                        <div>
                            <p class="font-medium">职业技能考试</p>
                            <p class="text-gray-500">6月15日-20日</p>
                        </div>
                    </li>
                    <li class="flex items-start">
                        <div class="bg-primary/10 text-primary text-xs font-semibold px-2 py-1 rounded mr-2 mt-0.5">7月</div>
                        <div>
                            <p class="font-medium">专升本报名</p>
                            <p class="text-gray-500">7月1日-15日</p>
                        </div>
                    </li>
                    <li class="flex items-start">
                        <div class="bg-primary/10 text-primary text-xs font-semibold px-2 py-1 rounded mr-2 mt-0.5">8月</div>
                        <div>
                            <p class="font-medium">升学考试</p>
                            <p class="text-gray-500">8月20日-25日</p>
                        </div>
                    </li>
                    <li class="flex items-start">
                        <div class="bg-primary/10 text-primary text-xs font-semibold px-2 py-1 rounded mr-2 mt-0.5">9月</div>
                        <div>
                            <p class="font-medium">录取结果公布</p>
                            <p class="text-gray-500">9月10日起</p>
                        </div>
                    </li>
                </ul>
            </div>
        </aside>
    </main>

    <!-- 报告生成模态框 -->
    <div id="report-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-lg w-full max-w-md p-6 transform transition-all">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">生成咨询报告</h3>
                <button id="close-report-modal" class="text-gray-500 hover:text-gray-700">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">学生姓名</label>
                    <input type="text" id="student-name" class="w-full p-2 border border-gray-300 rounded-lg" placeholder="请输入学生姓名">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">报告标题</label>
                    <input type="text" id="report-title" class="w-full p-2 border border-gray-300 rounded-lg" value="职业教育升学咨询报告">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">咨询类别</label>
                    <select id="consultation-type" class="w-full p-2 border border-gray-300 rounded-lg">
                        <option value="综合咨询">综合咨询</option>
                        <option value="升学途径">升学途径</option>
                        <option value="院校选择">院校选择</option>
                        <option value="专业介绍">专业介绍</option>
                        <option value="证书考试">证书考试</option>
                        <option value="就业前景">就业前景</option>
                    </select>
                </div>
                <div class="pt-2">
                    <button id="generate-pdf" class="w-full bg-primary text-white py-2 rounded-lg hover:bg-primary/90 transition-colors">
                        生成PDF报告
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 用于PDF生成的隐藏模板 -->
    <div id="pdf-template" class="hidden">
        <div style="width: 210mm; min-height: 297mm; padding: 20mm; font-family: 'Microsoft YaHei', 'SimHei', '微软雅黑', '黑体', sans-serif; font-size: 14px; line-height: 1.5; background-color: #ffffff;">
            <div class="text-center mb-10">
                <h1 style="font-size: 24px; margin-bottom: 10px; font-weight: bold;">职业教育升学咨询报告</h1>
                <p style="font-size: 16px;">HSX职业教育升学智能顾问</p>
            </div>
            
            <div style="margin-bottom: 15px;">
                <p><span style="font-weight: bold;">学生姓名：</span><span id="pdf-student-name">未知</span></p>
                <p><span style="font-weight: bold;">咨询日期：</span><span id="pdf-date">--</span></p>
                <p><span style="font-weight: bold;">咨询类别：</span><span id="pdf-type">综合咨询</span></p>
            </div>
            
            <div style="border-top: 1px solid #000; padding-top: 10px; margin-bottom: 15px;">
                <h2 style="font-size: 18px; margin-bottom: 10px; font-weight: bold;">一、咨询摘要</h2>
                <div id="pdf-summary" style="line-height: 1.5;">
                    本次咨询围绕职业教育升学相关问题展开，主要涉及升学途径、院校选择、专业介绍等方面的内容。咨询顾问根据学生的具体情况，提供了个性化的建议和指导。
                </div>
            </div>
            
            <div style="border-top: 1px solid #000; padding-top: 10px;">
                <h2 style="font-size: 18px; margin-bottom: 10px; font-weight: bold;">二、详细咨询记录</h2>
                <div id="pdf-details" style="line-height: 1.5;">
                    详细对话内容将显示在此处...
                </div>
            </div>
            
            <div style="margin-top: 30px; text-align: right; font-size: 12px; position: absolute; bottom: 20mm; right: 20mm; width: calc(100% - 40mm);">
                <p>报告生成于：<span id="pdf-generated-date">--</span></p>
                <p>一对一职业教育升学智能顾问 © 2025</p>
            </div>
        </div>
    </div>

    <script>
        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            // 获取DOM元素
            const chatForm = document.getElementById('chat-form');
            const userInput = document.getElementById('user-input');
            const chatHistory = document.getElementById('chat-history');
            const voiceInputBtn = document.getElementById('voice-input');
            const themeToggle = document.getElementById('theme-toggle');
            const navbar = document.getElementById('navbar');
            const modelStatusBtn = document.getElementById('model-status');
            const generateReportBtn = document.getElementById('generate-report');
            const reportModal = document.getElementById('report-modal');
            const closeReportModalBtn = document.getElementById('close-report-modal');
            const generatePdfBtn = document.getElementById('generate-pdf');
            const studentNameInput = document.getElementById('student-name');
            const consultationTypeSelect = document.getElementById('consultation-type');
            const welcomeModal = document.getElementById('welcome-modal');
            const privacyModal = document.getElementById('privacy-modal');
            const viewPrivacyBtn = document.getElementById('view-privacy');
            const closePrivacyBtn = document.getElementById('close-privacy');
            const acceptPrivacyBtn = document.getElementById('accept-privacy');
            const acceptPrivacyFromDetailsBtn = document.getElementById('accept-privacy-from-details');
            
            // 存储对话历史
            let conversationHistory = [];
            
            // 隐私协议相关事件
            viewPrivacyBtn.addEventListener('click', function() {
                welcomeModal.classList.add('hidden');
                privacyModal.classList.remove('hidden');
            });
            
            closePrivacyBtn.addEventListener('click', function() {
                privacyModal.classList.add('hidden');
                welcomeModal.classList.remove('hidden');
            });
            
            function acceptPrivacy() {
                welcomeModal.classList.add('hidden');
                privacyModal.classList.add('hidden');
                
                // 启用聊天输入
                userInput.disabled = false;
                const submitBtn = chatForm.querySelector('button[type="submit"]');
                submitBtn.disabled = false;
                submitBtn.classList.remove('bg-gray-300', 'text-gray-500', 'cursor-not-allowed');
                submitBtn.classList.add('bg-primary', 'text-white', 'hover:bg-primary/90');
                voiceInputBtn.disabled = false;
                voiceInputBtn.querySelector('i').classList.remove('text-gray-400');
                voiceInputBtn.querySelector('i').classList.add('text-gray-500');
                
                // 显示欢迎消息
                addWelcomeMessage();
            }
            
            acceptPrivacyBtn.addEventListener('click', acceptPrivacy);
            acceptPrivacyFromDetailsBtn.addEventListener('click', acceptPrivacy);
            
            // 添加表单提交事件处理
            chatForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                // 检查隐私协议是否已接受
                if (welcomeModal.classList.contains('hidden') === false) {
                    // 如果隐私协议模态框未隐藏，则显示它
                    welcomeModal.classList.remove('hidden');
                    return;
                }
                
                const message = userInput.value.trim();
                if (message) {
                    // 添加用户消息到聊天界面
                    addMessageToChat(message, true);
                    
                    // 清空输入框
                    userInput.value = '';
                    
                    // 增加用户提问计数
                    userQuestionCount++;
                    
                    // 获取AI回复
                    const aiResponse = await getAIResponse(message);
                    
                    // 添加AI回复到聊天界面
                    addMessageToChat(aiResponse, false);
                }
            });
            
            // 添加欢迎消息
            function addWelcomeMessage() {
                const welcomeDiv = document.createElement('div');
                welcomeDiv.className = 'flex items-start space-x-3';
                welcomeDiv.innerHTML = `
                    <div class="bg-primary text-white p-2 rounded-full">
                        <i class="fa fa-robot"></i>
                    </div>
                    <div class="bg-gray-50 rounded-xl p-4 max-w-[80%]">
                        <p class="text-gray-800">感谢您的信任！为了更好地为您提供职业教育升学建议，您可以告诉我：<br>
                        1. 您目前的教育阶段（如中职、高职等）<br>
                        2. 您感兴趣的专业领域<br>
                        3. 您的升学目标（如专升本、职业本科等）<br>
                        我会根据您的情况提供个性化建议。</p>
                    </div>
                `;
                
                chatHistory.appendChild(welcomeDiv);
                scrollToBottom();
                
                // 保存到对话历史
                conversationHistory.push({
                    role: 'assistant',
                    content: '感谢您的信任！为了更好地为您提供职业教育升学建议，您可以告诉我：1. 您目前的教育阶段（如中职、高职等）2. 您感兴趣的专业领域3. 您的升学目标（如专升本、职业本科等）我会根据您的情况提供个性化建议。'
                });
            }
            
            // 滚动到聊天底部
            function scrollToBottom() {
                chatHistory.scrollTop = chatHistory.scrollHeight;
            }
            
            // 添加消息到聊天界面
            function addMessageToChat(message, isUser) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'flex items-start space-x-3';
                
                if (isUser) {
                    messageDiv.innerHTML = `
                        <div class="flex-grow"></div>
                        <div class="bg-primary/10 rounded-xl p-4 max-w-[80%]">
                            <p class="text-gray-800">${message}</p>
                        </div>
                        <div class="bg-gray-200 text-gray-700 p-2 rounded-full">
                            <i class="fa fa-user"></i>
                        </div>
                    `;
                } else {
                    // 格式化AI回答以提高条理性
                    const formattedMessage = formatAIResponse(message);
                    messageDiv.innerHTML = `
                        <div class="bg-primary text-white p-2 rounded-full">
                            <i class="fa fa-robot"></i>
                        </div>
                        <div class="bg-gray-50 rounded-xl p-4 max-w-[80%] ai-response">
                            ${formattedMessage}
                        </div>
                    `;
                }
                
                chatHistory.appendChild(messageDiv);
                scrollToBottom();
                
                // 保存到对话历史
                conversationHistory.push({
                    role: isUser ? 'user' : 'assistant',
                    content: message
                });
            }
            
            // 添加"正在思考"动画
            function addTypingIndicator() {
                const typingDiv = document.createElement('div');
                typingDiv.className = 'flex items-start space-x-3';
                typingDiv.id = 'typing-indicator';
                typingDiv.innerHTML = `
                    <div class="bg-primary text-white p-2 rounded-full">
                        <i class="fa fa-robot"></i>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-4 max-w-[80%]">
                        <div class="flex space-x-1">
                            <span class="typing-dot"></span>
                            <span class="typing-dot"></span>
                            <span class="typing-dot"></span>
                        </div>
                    </div>
                `;
                
                chatHistory.appendChild(typingDiv);
                scrollToBottom();
            }
            
            // 移除"正在思考"动画
            function removeTypingIndicator() {
                const typingIndicator = document.getElementById('typing-indicator');
                if (typingIndicator) {
                    typingIndicator.remove();
                }
            }
            
            // 添加询问计数器
            let userQuestionCount = 0;
            
            // 调用DeepSeek API获取回复
            async function getAIResponse(userMessage) {
                try {
                    // 显示"正在思考"动画
                    addTypingIndicator();
                    
                    // 根据询问次数设置不同的系统提示
                    let systemPrompt = "你是一个专注于职业教育升学咨询的智能助手。";
                    
                    if (userQuestionCount < 5) {
                        systemPrompt += "在前五次交互中，请简要概括用户特点，并主动引导用户提供以下升学相关信息：目前的教育阶段（如初中、高中、中职等）、感兴趣的专业领域（如计算机、机械、护理等）、升学目标（如想升入高职、本科或有其他具体目标）。请保持回答简洁，并在结尾提供1-2个具体的升学相关问题示例来引导用户继续提问，例如：'您目前在哪个教育阶段学习？'或'您对哪些专业领域感兴趣？";
                    } else {
                        systemPrompt += "请以清晰准确完备有条理的方式回答用户的问题，提供相关的政策信息、升学途径、院校选择建议、专业介绍等内容。请确保回答内容准确、实用，并根据用户的具体问题提供个性化建议。如果用户询问具体的专业或院校信息，请提供详细且结构化的回答，包括专业特点、就业前景、推荐院校等。如果用户询问升学考试相关信息，请提供考试科目、考试时间、考试地点等。如果用户询问其他问题，请提供相关的专业知识或升学建议。如果用户询问其他问题，请提供相关的专业知识或升学建议。";
                    }
                    
                    // 准备API请求数据
                    const messages = [
                        {
                            role: "system",
                            content: systemPrompt
                        },
                        ...conversationHistory,
                        {
                            role: "user",
                            content: userMessage
                        }
                    ];
                    
                    // 构建API请求
                    const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer sk-37ae9c5a66764abca05c91e142157daa'
                        },
                        body: JSON.stringify({
                            model: 'deepseek-chat',
                            messages: messages,
                            temperature: 0.7,
                            max_tokens: 1000
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`API请求失败: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    const aiResponse = data.choices[0].message.content;
                    
                    // 移除"正在思考"动画
                    removeTypingIndicator();
                    
                    return aiResponse;
                } catch (error) {
                    console.error('获取AI回复时出错:', error);
                    
                    // 移除"正在思考"动画
                    removeTypingIndicator();
                    
                    // 返回错误消息
                    return "很抱歉，获取回复时发生错误。请稍后再试。";
                }
            }
            
            // 格式化AI回答以提高条理性
            function formatAIResponse(response) {
                // 前五次询问：简要概括用户特点，并引导用户提问
                if (userQuestionCount < 5) {
                    // 保持AI回复的简洁性，仅进行基本的HTML格式化
                    let simplifiedResponse = response.trim();
                    
                    // 移除可能的问候语
                    if (simplifiedResponse.startsWith("你好") || simplifiedResponse.startsWith("您好")) {
                        simplifiedResponse = simplifiedResponse.substring(simplifiedResponse.indexOf("，") + 1).trim();
                    }
                    
                    // 如果回答过长，进行截断
                    if (simplifiedResponse.length > 200) {
                        simplifiedResponse = simplifiedResponse.substring(0, 200) + "...";
                    }
                    
                    // 统一格式化，确保每次回复都保持简洁一致
                    return `<p>${simplifiedResponse}</p><p style="margin-top: 10px; font-weight: bold;">请告诉我更多关于您的情况，如您目前的教育阶段、感兴趣的专业领域、升学目标等，我将为您提供更详细的建议。</p>`;
                }
                
                // 第六次及以后的询问：以清晰准确完备有条理的方式回答
                // 精简AI回答
                // 移除开头和结尾的空白字符
                let trimmedResponse = response.trim();
                
                // 如果回答以问候语开头，则移除
                if (trimmedResponse.startsWith("你好") || trimmedResponse.startsWith("您好")) {
                    trimmedResponse = trimmedResponse.substring(trimmedResponse.indexOf("，") + 1).trim();
                }
                
                // 检查是否已经是结构化内容（包含明显的标题或列表）
                const hasStructure = trimmedResponse.includes('\n\n1.') || 
                                     trimmedResponse.includes('\n\n一、') || 
                                     trimmedResponse.includes('\n\n二、') || 
                                     trimmedResponse.includes('\n- ') || 
                                     trimmedResponse.includes('\n* ');
                
                if (hasStructure) {
                    // 对已有的结构化内容进行更好的HTML转换
                    return formatStructuredResponse(trimmedResponse);
                } else {
                    // 对非结构化内容进行智能分段和结构化处理
                    return formatUnstructuredResponse(trimmedResponse);
                }
            }
            
            
            // 报告生成模态框事件处理
generateReportBtn.addEventListener('click', function() {
    reportModal.classList.remove('hidden');
});

closeReportModalBtn.addEventListener('click', function() {
    reportModal.classList.add('hidden');
});

// 生成报告仪表板
generatePdfBtn.addEventListener('click', function() {
    const studentName = studentNameInput.value || '未知';
    const reportTitle = document.getElementById('report-title').value || '职业教育升学咨询报告';
    const consultationType = consultationTypeSelect.value || '综合咨询';
    
    // 生成咨询摘要
    let summary = '本次咨询围绕职业教育升学相关问题展开，主要涉及';
    const topics = [];
    
    // 分析对话历史生成摘要
    conversationHistory.forEach(msg => {
        if (msg.role === 'user') {
            if ((msg.content.includes('升学') || msg.content.includes('专升本')) && !topics.includes('升学途径')) {
                topics.push('升学途径');
            }
            if (msg.content.includes('专业') && !topics.includes('专业介绍')) {
                topics.push('专业介绍');
            }
            if ((msg.content.includes('院校') || msg.content.includes('学校')) && !topics.includes('院校选择')) {
                topics.push('院校选择');
            }
            if (msg.content.includes('就业') && !topics.includes('就业前景')) {
                topics.push('就业前景');
            }
            if ((msg.content.includes('证书') || msg.content.includes('考试')) && !topics.includes('证书考试')) {
                topics.push('证书考试');
            }
        }
    });
    
    summary += topics.length > 0 ? topics.join('、') + '等方面的内容。' : '多个方面的问题。';
    summary += '咨询顾问根据学生的具体情况，提供了个性化的建议和指导。';
    
    // 生成详细咨询记录
    let detailsHTML = '';
    conversationHistory.forEach((msg, index) => {
        if (msg.role === 'user') {
            detailsHTML += `<div style="margin-bottom: 15px;"><strong>学生：</strong>${msg.content}</div>`;
        } else {
            // 移除AI回复中的HTML标签以获得纯文本
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = formatAIResponse(msg.content);
            const plainText = tempDiv.textContent || tempDiv.innerText || '';
            detailsHTML += `<div style="margin-bottom: 15px;"><strong>顾问：</strong>${plainText}</div>`;
        }
    });
    
    // 构建URL参数
    const params = new URLSearchParams({
        studentName: encodeURIComponent(studentName),
        reportTitle: encodeURIComponent(reportTitle),
        consultationType: encodeURIComponent(consultationType),
        date: encodeURIComponent(new Date().toLocaleDateString('zh-CN')),
        generatedDate: encodeURIComponent(new Date().toLocaleString('zh-CN')),
        summary: encodeURIComponent(summary),
        details: encodeURIComponent(detailsHTML)
    });
    
    // 跳转到报告仪表板页面
    window.open(`report-dashboard.html?${params.toString()}`, '_blank');
    
    // 关闭模态框
    reportModal.classList.add('hidden');
});
           
            // 初始化页面
            scrollToBottom();
        });
    </script>
</body>
</html>
