<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>专宝JOBO职业教育升学咨询报告</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            padding: 30px 0;
            background: linear-gradient(90deg, #4b6cb7 0%, #182848 100%);
            color: white;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .report-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            padding: 30px;
            margin-bottom: 30px;
            transition: transform 0.3s ease;
        }
        
        .report-card:hover {
            transform: translateY(-5px);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .card-header h2 {
            color: #4b6cb7;
            font-size: 1.8rem;
        }
        
        .report-meta {
            background: #eef2f7;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            color: #4b6cb7;
            font-weight: 500;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .info-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #4b6cb7;
            transition: all 0.3s ease;
        }
        
        .info-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transform: translateY(-2px);
        }
        
        .info-item h3 {
            color: #4b6cb7;
            margin-bottom: 10px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .info-item p {
            font-size: 1.2rem;
            font-weight: 500;
            color: #333;
        }
        
        .section {
            margin-bottom: 30px;
        }
        
        .section h2 {
            color: #4b6cb7;
            font-size: 1.5rem;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-content {
            line-height: 1.8;
            font-size: 1.1rem;
            color: #333;
        }
        
        .section-content p {
            margin-bottom: 15px;
        }
        
        .section-content ul, .section-content ol {
            padding-left: 30px;
            margin: 15px 0;
        }
        
        .section-content li {
            margin-bottom: 8px;
        }
        
        .section-content strong {
            font-weight: 600;
        }
        
        .footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 0.9rem;
            border-top: 1px solid #eee;
            margin-top: 20px;
        }
        
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 30px 0;
        }
        
        .btn {
            padding: 12px 25px;
            border-radius: 30px;
            border: none;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(90deg, #4b6cb7 0%, #182848 100%);
            color: white;
        }
        
        .btn-secondary {
            background: #f8f9fa;
            color: #4b6cb7;
            border: 1px solid #ddd;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        
        .btn-primary:hover {
            background: linear-gradient(90deg, #3a5ca5 0%, #121f3d 100%);
        }
        
        /* AI推荐部分样式 */
        /* AI推荐部分样式 */
        /* 用户画像区域统一布局样式 */
        .user-profile-card {
            background: #fff;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .profile-item {
            display: flex;
            margin-bottom: 8px;
            align-items: flex-start;
            line-height: 1.5;
        }
        
        .profile-label {
            font-weight: 600;
            color: #4b6cb7;
            min-width: 100px;
            max-width: 140px;
            word-wrap: break-word;
            overflow-wrap: break-word;
            font-size: 14px;
        }
        
        .profile-value {
            flex: 1;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
            font-size: 14px;
            line-height: 1.5;
            color: #333;
        }
        
        .profile-analysis {
            display: flex;
            align-items: flex-start;
            margin-bottom: 6px;
            color: #666;
            font-size: 13px;
            line-height: 1.4;
        }
        
        .profile-analysis i {
            color: #28a745;
            margin-right: 8px;
            margin-top: 2px;
            flex-shrink: 0;
        }
        
        /* 用户画像pre标签样式 - 保持可见 */
        #user-profile {
            white-space: pre-wrap;
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            font-size: 14px;
            line-height: 1.5;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
        }
        
        .ai-summary-content {
            background: #fff;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
        }
        
        .summary-paragraph {
            margin-bottom: 15px;
            line-height: 1.6;
            text-align: justify;
        }
        
        .recommendations-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .recommendation-category {
            background: #fff;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #e9ecef;
        }
        
        .recommendation-category h4 {
            color: #4b6cb7;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .recommendation-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .recommendation-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        
        .recommendation-item i {
            color: #ffc107;
            margin-right: 10px;
            margin-top: 2px;
        }
        
        .action-steps {
            counter-reset: step-counter;
        }
        
        .action-step {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 12px;
            background: #e8f4f8;
            border-radius: 6px;
            border-left: 3px solid #17a2b8;
        }
        
        .step-number {
            background: #17a2b8;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 12px;
            flex-shrink: 0;
        }
        
        .step-content {
            flex: 1;
        }
                /* 修复用户画像行太宽的问题 */
        #user-profile {
            max-width: 100%;
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: pre-wrap;
        }
        
        .profile-value {
            max-width: 200px;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .info-grid {
                grid-template-columns: 1fr;
            }
            
            .recommendations-section {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .card-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .action-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            .report-meta {
                align-self: flex-start;
            }
        }
        
        @media (max-width: 480px) {
            .header {
                padding: 20px 15px;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
            
            .report-card {
                padding: 20px 15px;
            }
            
            .info-item {
                padding: 15px;
            }
            
            .info-item h3 {
                font-size: 1rem;
            }
            
            .info-item p {
                font-size: 1.1rem;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="header">
            <h1>
                <img src="1111.png" alt="专宝JOBO智能顾问" loading="lazy" style="height: 2.5em; vertical-align: middle; margin-right: 15px;">
                  <i class="fas fa-graduation-cap"></i> 职业教育升学咨询报告
            </h1>
            <p>一对一职业教育升学智能顾问</p>
        </div>
        
        <div class="report-card">
            <div class="card-header">
                <h2 id="report-title">报告详情</h2>
                <div class="report-meta">
                    <span id="consultation-type"></span>
                </div>
            </div>
            
            <div class="info-grid">
                <div class="info-item">
                    <h3><i class="fas fa-user"></i> 学生姓名</h3>
                    <p id="student-name">未知</p>
                </div>
                <div class="info-item">
                    <h3><i class="fas fa-calendar-alt"></i> 咨询日期</h3>
                    <p id="consultation-date">--</p>
                </div>
                <div class="info-item">
                    <h3><i class="fas fa-file-alt"></i> 报告生成时间</h3>
                    <p id="generated-date">--</p>
                </div>
            </div>
            
            <div class="section">
                <h2><i class="fas fa-star"></i> 咨询摘要</h2>
                <div id="summary" class="section-content">
                    <!-- 摘要内容将通过JavaScript填充 -->
                </div>
            </div>
            
            <div class="section">
                <h2><i class="fas fa-comments"></i> 详细咨询记录</h2>
                <div id="details" class="section-content">
                    <!-- 详细内容将通过JavaScript填充 -->
                </div>
            </div>
            
            <!-- 新增AI总结推荐区块 -->
            <div class="section">
                <h2><i class="fas fa-robot"></i> AI总结与推荐</h2>
                <div id="ai-summary" class="section-content">
                    <div id="ai-recommendation-loading" style="text-align: center; padding: 20px;">
                        <p><i class="fas fa-spinner fa-spin"></i> 正在生成个性化推荐...</p>
                    </div>
                    <div id="ai-recommendation-content" style="display: none;">
                        <h3>用户画像</h3>
                        <pre id="user-profile" style="white-space: pre-wrap; background-color: #f5f5f5; padding: 10px; border-radius: 5px;"></pre>
                        
                        <h3>总结</h3>
                        <div id="ai-summary-text"></div>
                        
                        <h3>推荐</h3>
                        <div id="ai-recommendations"></div>
                        
                        
                        
;
                    </div>
                </div>
            </div>
            <!-- 结束AI总结推荐区块 -->
            
            <div class="action-buttons">
                <button class="btn btn-primary" id="print-btn">
                    <i class="fas fa-print"></i> 打印报告
                </button>
                <button class="btn btn-secondary" id="export-btn">
                    <i class="fas fa-download"></i> 导出报告
                </button>
            </div>
            
            <div class="footer">
                <p>报告生成于：<span id="footer-generated-date">--</span></p>
                <p>HSX职业教育升学智能顾问 © 2025</p>
            </div>
        </div>
    </div>

    <script>
        // 获取URL参数
        function getQueryParams() {
            // 首先尝试从localStorage获取数据
            const reportData = localStorage.getItem('reportData');
            if (reportData) {
                try {
                    return JSON.parse(reportData);
                } catch (e) {
                    console.error('解析报告数据时出错:', e);
                }
            }
            
            // 如果localStorage中没有数据，则回退到URL参数方式（兼容旧版本）
            const params = new URLSearchParams(window.location.search);
            const decodedParams = {};
            for (const [key, value] of params) {
                decodedParams[key] = decodeURIComponent(value);
            }
            return decodedParams;
        }

        // 生成结构化的用户画像HTML
        function generateStructuredUserProfile(userProfile) {
            const profileLines = userProfile.split('\n');
            let profileHTML = '<div class="user-profile-card">';
            
            profileLines.forEach(line => {
                if (line.trim()) {
                    if (line.includes('：')) {
                        const [key, value] = line.split('：');
                        profileHTML += `
                            <div class="profile-item">
                                <span class="profile-label">${key}：</span>
                                <span class="profile-value">${value}</span>
                            </div>
                        `;
                    } else if (line.startsWith('-')) {
                        profileHTML += `
                            <div class="profile-analysis">
                                <i class="fas fa-check-circle"></i>
                                <span>${line.substring(1).trim()}</span>
                            </div>
                        `;
                    }
                }
            });
            
            profileHTML += '</div>';
            return profileHTML;
        }
        
        // 格式化AI总结内容
        function formatAISummary(summary) {
            // 清理AI生成的符号和格式
            let cleanedSummary = summary
                .replace(/#{1,6}\s*/g, '')  // 移除Markdown标题符号 (#, ##, ###等)
                .replace(/\*\*(.*?)\*\*/g, '$1')  // 移除加粗符号 **text**
                .replace(/\*(.*?)\*/g, '$1')  // 移除斜体符号 *text*
                .replace(/`(.*?)`/g, '$1')  // 移除代码符号 `text`
                .replace(/^\s*[-*+]\s+/gm, '• ')  // 将列表符号改为更优雅的圆点
                .replace(/^\s*\d+\.\s+/gm, '')  // 移除数字列表符号
                .replace(/\n{3,}/g, '\n\n');  // 减少过多的空行
            
            // 按段落分割
            const paragraphs = cleanedSummary.split('\n\n').filter(p => p.trim());
            
            let summaryHTML = '<div class="ai-summary-content">';
            paragraphs.forEach(paragraph => {
                if (paragraph.trim()) {
                    summaryHTML += `<p class="summary-paragraph">${paragraph.trim()}</p>`;
                }
            });
            summaryHTML += '</div>';
            
            return summaryHTML;
        }
        
        // 分类显示推荐内容
        function displayRecommendationsByCategory(recommendations, nextSteps) {
            const recommendationsHTML = `
                <div class="recommendations-section">
                    <div class="recommendation-category">
                        <h4><i class="fas fa-lightbulb"></i> 专业建议</h4>
                        <div class="recommendation-list">
                            ${recommendations.map(rec => 
                                `<div class="recommendation-item">
                                    <i class="fas fa-star"></i>
                                    <span>${rec.replace(/^\d+\.\s*/, '')}</span>
                                </div>`
                            ).join('')}
                        </div>
                    </div>
                    
                    <div class="recommendation-category">
                        <h4><i class="fas fa-tasks"></i> 行动计划</h4>
                        <div class="action-steps">
                            ${nextSteps.map(step => 
                                `<div class="action-step">
                                    <span class="step-number">${step.match(/^\d+/)[0]}</span>
                                    <span class="step-content">${step.replace(/^\d+\.\s*/, '')}</span>
                                </div>`
                            ).join('')}
                        </div>
                    </div>
                </div>
            `;
            
            return recommendationsHTML;
        }
        
        // 更新AI推荐显示函数
        function updateAIRecommendationsDisplay(userProfile, aiSummary, aiRecommendations, nextSteps) {
            // 显示用户画像（直接显示原始文本格式）
            document.getElementById('user-profile').textContent = userProfile;
            
            // 显示格式化的AI总结
            document.getElementById('ai-summary-text').innerHTML = formatAISummary(aiSummary);
            
            // 显示分类的推荐内容
            document.getElementById('ai-recommendations').innerHTML = displayRecommendationsByCategory(aiRecommendations, nextSteps);
            
            // 显示内容并隐藏加载状态
            document.getElementById('ai-recommendation-loading').style.display = 'none';
            document.getElementById('ai-recommendation-content').style.display = 'block';
        }

        // 生成AI总结和推荐
        async function generateAISummaryAndRecommendations(details) {
            // 显示加载状态
            document.getElementById('ai-recommendation-loading').style.display = 'block';
            document.getElementById('ai-recommendation-content').style.display = 'none';
            
            try {
            // 模拟API调用延迟
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            // 从URL参数中获取学生信息
            const params = getQueryParams();
            const studentName = params.studentName || '';
            const educationStage = localStorage.getItem('educationLevel') || '';
            const interestMajor = localStorage.getItem('interestMajor') || '';
            const 升学目标 = localStorage.getItem('升学目标') || '';
            
            // 从对话详情中提取更多用户信息
            let extractedInfo = {};
            
            // 从对话详情中提取关键信息
            const parser = new DOMParser();
            const doc = parser.parseFromString(details, 'text/html');
            const userMessages = doc.querySelectorAll('div strong:first-child');
            
            userMessages.forEach(msg => {
                const content = msg.parentElement.textContent;
                if (content.includes('教育阶段') || content.includes('目前在')) {
                    // 提取教育阶段
                    const matches = content.match(/(?:教育阶段|目前在)(?:是)?([\u4e00-\u9fa5]+)/);
                    if (matches && matches[1]) {
                        extractedInfo.educationStage = matches[1];
                    }
                }
                if (content.includes('专业') || content.includes('感兴趣')) {
                    // 提取感兴趣的专业
                    const matches = content.match(/(?:专业|感兴趣)(?:是)?([\u4e00-\u9fa5]+)/);
                    if (matches && matches[1]) {
                        extractedInfo.interestMajor = matches[1];
                    }
                }
                if (content.includes('升学目标') || content.includes('目标')) {
                    // 提取升学目标
                    const matches = content.match(/(?:升学目标|目标)(?:是)?([\u4e00-\u9fa5]+)/);
                    if (matches && matches[1]) {
                        extractedInfo.升学目标 = matches[1];
                    }
                }
            });
            
            // 合并表格信息和提取的信息
            const finalEducationStage = educationStage || extractedInfo.educationStage || '';
            const finalInterestMajor = interestMajor || extractedInfo.interestMajor || '';
            const final升学目标 = 升学目标 || extractedInfo.升学目标 || '';
            
            // 生成用户画像
            let userProfile = "学生画像：\n";
            if (studentName) userProfile += `姓名：${studentName}\n`;
            if (finalEducationStage) userProfile += `教育阶段：${finalEducationStage}\n`;
            if (finalInterestMajor) userProfile += `感兴趣的专业领域：${finalInterestMajor}\n`;
            if (final升学目标) userProfile += `升学目标：${final升学目标}\n`;
            
            // 添加从对话中提取的其他信息
            userProfile += "\n通过对话分析得出的更多信息：\n";
            userProfile += "- 对职业教育升学途径表现出浓厚兴趣\n";
            userProfile += "- 希望了解专业选择和就业前景\n";
            userProfile += "- 关注专升本相关政策和要求\n";
            
         
            
            // 调用API进行性格和兴趣分析
            // 构建API请求
            const messages = [
                { role: "system", content: "你是一个专业的升学顾问，根据学生提供的信息进行分析，给出个性化的升学和就业建议（分开写）。" },
                { role: "user", content: userProfile }
            ];
            
            const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json', 
                    'Authorization': 'Bearer sk-f4272a6f46524f5e8b21268c0fa287aa'
                }, 
                body: JSON.stringify({
                    model: 'deepseek-chat', 
                    messages: messages, 
                    temperature: 0.7, 
                    max_tokens: 1000
                })
            });
            
            if (!response.ok) {
                throw new Error(`API请求失败: ${response.status}`);
            }
            
            const apiResult = await response.json();
            
            // 解析API响应
            let aiSummary = "根据分析，建议您重点关注与您感兴趣专业相关的院校和升学途径，同时了解相关的证书考试要求。";
            let aiRecommendations = [
                "1. 深入了解" + (finalInterestMajor || "您感兴趣的专业") + "的课程设置和就业前景",
                "2. 研究" + (finalEducationStage || "您当前教育阶段") + "对应的升学途径和要求",
                "3. 关注相关专业的证书考试信息，提前规划考证时间",
                "4. 了解目标院校的招生政策和录取要求",
                "5. 参加相关的专业讲座或校园开放日活动"
            ];
            let nextSteps = [
                "1. 完善个人信息，特别是教育阶段和感兴趣的专业领域",
                "2. 浏览院校选择页面，了解各院校的特色专业",
                "3. 查看证书考试页面，了解相关考试的报名时间和要求",
                "4. 关注就业前景页面，了解各专业的就业情况",
                "5. 定期与升学顾问沟通，获取最新的升学政策信息"
            ];
            
            // 从API响应中提取信息（如果存在）
            if (apiResult.choices && apiResult.choices.length > 0) {
                const content = apiResult.choices[0].message.content;
                // 这里可以根据API返回的格式解析内容
                // 为简化示例，我们直接使用返回的内容作为总结
                aiSummary = content;
                // 推荐和下一步行动可以根据实际API响应格式进行解析
            }
            
            // 使用新的规范化显示函数
            updateAIRecommendationsDisplay(userProfile, aiSummary, aiRecommendations, nextSteps);
            
        } catch (error) {
            console.error('生成AI总结和推荐时出错:', error);
            document.getElementById('ai-recommendation-loading').innerHTML = 
                `<p><i class="fas fa-exclamation-circle"></i> 生成推荐时出现错误：${error.message}。请稍后重试。</p>`;
        }
        }

        // 填充报告数据
        function populateReport() {
            const params = getQueryParams();
            
            document.getElementById('report-title').textContent = params.reportTitle;
            document.getElementById('student-name').textContent = params.studentName;
            document.getElementById('consultation-date').textContent = params.date;
            document.getElementById('consultation-type').textContent = params.consultationType;
            document.getElementById('summary').textContent = params.summary;
            document.getElementById('generated-date').textContent = params.generatedDate;
            document.getElementById('footer-generated-date').textContent = params.generatedDate;
            
            // 解析并显示对话详情
            if (params.details) {
                const detailsContainer = document.getElementById('details');
                
                // 为了安全起见，应该使用DOMPurify或其他库来防止XSS攻击
                // 这里提供一个简单的处理方式
                try {
                    // 创建一个临时div来处理HTML内容
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = params.details;
                    
                    // 清理潜在的危险元素（简单处理）
                    const dangerousElements = tempDiv.querySelectorAll('script, iframe, object, embed');
                    dangerousElements.forEach(el => el.remove());
                    
                    detailsContainer.innerHTML = tempDiv.innerHTML;
                } catch (e) {
                    // 如果处理失败，仍然尝试使用innerHTML显示
                    detailsContainer.innerHTML = params.details;
                }
                
                // 生成AI总结和推荐
                generateAISummaryAndRecommendations(params.details);
            }
        }

        // 打印功能
        document.getElementById('print-btn').addEventListener('click', function() {
            window.print();
        });

        // 导出功能（简化版）
        document.getElementById('export-btn').addEventListener('click', function() {
            alert('导出功能已触发，实际应用中将生成PDF文件。');
        });

        // 页面加载完成后填充数据
        document.addEventListener('DOMContentLoaded', populateReport);
    </script>
</body>
</html>

       